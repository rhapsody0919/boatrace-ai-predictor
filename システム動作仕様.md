# ボートレースAI予想サイト - システム動作仕様

## 概要

本システムは、GitHub ActionsとGitHub Pagesを使用した静的サイトで、**24時間を通して当日のレースデータを提供**します。

**現在の運用状態: テスト中（1時間間隔で24時間実行）**

---

## 📅 日次スケジュール

### 🕐 24時間スクレイピング（テスト運用）

**GitHub Actionsの動作:**
```yaml
# テスト中: 1時間間隔で24時間実行
cron: '0 * * * *'
```

**実行スケジュール:**
```
0:00, 1:00, 2:00, 3:00, 4:00, 5:00, 6:00, 7:00, 8:00, 9:00,
10:00, 11:00, 12:00, 13:00, 14:00, 15:00, 16:00, 17:00,
18:00, 19:00, 20:00, 21:00, 22:00, 23:00
（1時間間隔で24回実行）
```

**データの状態:**
- **当日のレースデータ**が表示される
- 深夜0:00の初回スクレイピングで、その日開催予定のレース場リストを取得
- レース詳細情報がまだ公開されていない場合は空配列、または基本情報のみ

**画面の表示:**
```
レースデータを読み込み中...
↓
【パターン1: レース情報が公開されている場合】
本日開催予定のレース場と基本情報を表示
（天候・気温などの詳細はまだ null の可能性あり）

【パターン2: レース情報がまだ公開されていない場合】
「本日、このレース場での開催はありません」
または空のデータ（data: []）
```

**処理内容:**
1. `scripts/scrape-to-json.js`が実行される
2. https://www.boatrace.jp/owpc/pc/race/index から本日開催中のレース場リストを取得
3. 各レース場の1R〜12Rのデータを並列取得（会場間は1秒の遅延）
4. `data/races.json`にデータを保存
5. Gitコミット＆プッシュ
6. GitHub Pages自動デプロイトリガー

**データの状態:**
```json
{
  "success": true,
  "data": [
    {
      "placeCd": 3,
      "placeName": "江戸川",
      "races": [
        {
          "date": "2025-11-28",
          "placeCd": 3,
          "raceNo": 1,
          "weather": "晴",
          "airTemp": 18.5,
          "windDirection": 2,
          "windVelocity": 3.2,
          "waterTemp": 16.8,
          "waveHeight": 2
        }
        // ... 最大12レース分
      ]
    }
    // ... 開催中の全会場（通常10〜12会場）
  ],
  "scrapedAt": "2025-11-28T01:00:00.000Z"  // UTC時刻（JST 10:00）
}
```

**デプロイ完了時刻:**
- スクレイピング: 約1〜2分
- デプロイ: 約2〜3分
- **合計: スクレイピング開始から3〜5分後にサイトが更新される**

**データ更新の流れ:**
1. 1時間ごとにスクレイピング実行
2. 最新のレース情報（天候、気温、風速など）を取得
3. `data/races.json`を上書き更新
4. 自動コミット＆プッシュ
5. GitHub Pagesが自動再デプロイ
6. **数分後にユーザーがリロードすると最新データが表示される**

**ユーザーの操作:**
- **重要:** ページは自動リロードされない
- 最新データを見るには**手動でリロード（F5またはCmd+R）が必要**

**ユーザー体験:**
- 0:00以降、当日の日付のデータが表示される
- 早朝はレース詳細情報が少ない可能性がある
- 1時間ごとに更新されるため、リロードすると徐々に情報が増える
- レース開催中（10:00-17:00頃）も1時間間隔で更新
- 夕方以降も当日のレースデータが保持される

---

## 🔄 データの鮮度について

### データ更新の遅延要因

1. **スクレイピング処理時間:** 約1〜2分
   - 会場数: 10〜12会場
   - 1会場あたり12レースを並列取得
   - 会場間の遅延: 1秒

2. **Git処理時間:** 約10〜20秒
   - コミット作成
   - GitHub へのプッシュ

3. **GitHub Pagesデプロイ時間:** 約2〜3分
   - ビルド処理
   - CDNへの配信

**合計遅延:** 約3〜5分

### 実際のユーザー体験

例: JST 10:00にスクレイピング開始の場合

```
10:00:00  GitHub Actions開始
10:01:30  スクレイピング完了、data/races.jsonに保存
10:01:40  Gitコミット＆プッシュ完了
10:01:45  GitHub Pagesデプロイ開始
10:04:30  デプロイ完了、サイトに最新データが反映

→ ユーザーが10:05にアクセスしてリロードすると最新データが見られる
→ 次回更新は11:00（1時間後）
```

---

## 📊 画面の状態遷移

### パターン1: 早朝にアクセス（7:00）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 当日のレースデータを表示
   （7:00頃にスクレイピングされたデータ）
   ↓
5. ドロップダウンに本日開催予定の会場が表示される
   （詳細情報はまだ少ない可能性あり）
```

### パターン2: 午前中にアクセス（10:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 10:00頃にスクレイピングされたデータを表示
   ↓
5. ドロップダウンに本日開催中の会場のみが表示される
   （例: 江戸川、浜名湖、常滑、津、住之江、鳴門、丸亀、徳山、若松、福岡、大村）
   ↓
6. 天候・気温・風速などの詳細情報が充実している
   ↓
7. 次回更新は11:00（1時間後）
```

### パターン3: 夕方にアクセス（18:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 18:00頃にスクレイピングされたデータを表示
   （本日のレース結果含む）
   ↓
5. 日付は本日、当日の全レースデータが表示される
   ↓
6. 次回更新は19:00（1時間後）
```

### パターン4: 深夜にアクセス（0:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 0:00頃にスクレイピングされた当日のデータを表示
   （まだレース詳細情報は少ない）
   ↓
5. 日付は本日だが、詳細情報は翌朝以降に充実する
   ↓
6. 次回更新は1:00（1時間後）
```

---

## 🎯 ユーザーへの推奨事項

### 最適なアクセス時間
- **0:00以降:** 当日のデータが表示される（詳細情報は少ない）
- **10:00以降:** レース詳細情報が充実し始める
- **レース開催中（10:00〜17:00）:** 1時間間隔で更新される（テスト中）
- **18:00以降:** レース結果の確認が可能

### データの鮮度を確認する方法
- ページ下部に表示される `scrapedAt` タイムスタンプを確認
- 例: `最終更新: 2025-11-28T01:15:00.000Z`（JST 10:15に相当）

### 最新データを取得するには
1. ブラウザをリロード（F5 または Cmd+R）
2. キャッシュクリアしてリロード（Ctrl+Shift+R または Cmd+Shift+R）

---

## ⚙️ 技術的な制約事項

### GitHub Actions無料プランの制限

- **月間実行時間:** 2,000分

**本システムの月間消費見込み（テスト運用: 1時間間隔で24時間）:**
```
【1日あたりの実行回数】
- 0:00-23:00: 1時間間隔 × 24回 = 24回/日

【月間消費時間の計算】
- 1回あたりの実行時間: 約1.5分（実測値）
- 月間消費: 24回 × 1.5分 × 30日 = 1,080分
- **制限内に十分収まる（2,000分の約54%）**

【安全マージン】
- 制限まで残り: 2,000分 - 1,080分 = 920分
- 実行時間が多少長くなっても余裕がある
- 今後15分間隔に変更しても対応可能
```

**本番運用時の推奨設定（15分間隔）:**
```
【1日あたりの実行回数（参考）】
- 0:00-9:00:   1時間間隔 × 10回 = 10回
- 10:00-17:00: 15分間隔 × 28回 = 28回
- 18:00-23:00: 1時間間隔 × 6回  = 6回
合計: 44回/日

【月間消費時間】
- 月間消費: 44回 × 1.5分 × 30日 = 1,980分
- ギリギリ制限内（2,000分の99%）
```

**制限を超えた場合の対策:**
1. レース開催時間（10:00-17:00）の間隔を30分に変更
2. 深夜・早朝の実行間隔を2時間に変更
3. 手動でワークフローを停止し、翌月まで待つ

### データ更新の仕組み
- **静的サイト:** サーバーサイド処理なし
- **データソース:** `/data/races.json`（Gitリポジトリにコミット）
- **更新トリガー:** GitHub Actionsのcron（1時間間隔で24時間実行 - テスト中）

### レート制限対策
- 会場間の取得に1秒の遅延を設定
- User-Agent: `BoatraceAIBot/1.0 (+https://github.com/rhapsody0919/boatrace-ai-predictor)`
- タイムアウト: 5秒

---

## 🛠️ トラブルシューティング

### 問題1: 「本日、このレース場での開催はありません」と表示される

**原因:**
- 早朝（0:00-6:00）でレース情報がまだ公開されていない
- GitHub Actionsが失敗している
- デプロイが遅延している
- 実際にレースが開催されていない日

**対処法:**
1. 時間を置いて（1-2時間後）再度アクセス
2. GitHub Actionsの実行ログを確認: https://github.com/rhapsody0919/boatrace-ai-predictor/actions
3. ブラウザキャッシュをクリアしてリロード
4. boatrace.jp で実際に開催があるか確認

### 問題2: データが古い（前日のデータが表示される）

**原因:**
- GitHub Actionsのスケジュール実行が失敗
- リポジトリの権限不足
- データ取得元サイト（boatrace.jp）がメンテナンス中
- 深夜0:00のスクレイピングがまだ実行されていない

**対処法:**
1. https://github.com/rhapsody0919/boatrace-ai-predictor/actions でワークフロー実行状況を確認
2. 手動でワークフローを実行（workflow_dispatch）
3. エラーログを確認して原因を特定
4. 0:05以降に再度アクセス（深夜0:00のスクレイピング完了後）

### 問題3: 特定の会場のデータが欠けている

**原因:**
- その会場のスクレイピングがタイムアウト
- 会場のページ構造が変更された
- 一時的なネットワークエラー

**対処法:**
1. 次回更新を待つ（レース開催中なら15分後、それ以外は1時間後）
2. GitHub Actionsのログで該当会場のエラーを確認
3. 必要に応じてスクレイピングロジックを修正

### 問題4: GitHub Actions無料枠を使い切った

**症状:**
- スケジュール実行が停止する
- データが更新されなくなる

**原因:**
- 月間2,000分の制限を超過

**対処法:**
1. GitHub Actionsのページで使用状況を確認
2. 翌月1日まで待つ（自動的にリセットされる）
3. 緊急時は手動でワークフローを実行（workflow_dispatch）
4. 長期的には実行間隔を調整（30分間隔、1時間間隔など）

---

## 📝 まとめ

### データ更新サイクル（テスト運用中）
- **0:00-23:00:** 1時間間隔で更新（24回/日）
- **合計:** 24回/日、月間1,080分（GitHub Actions無料枠の54%）
- **余裕:** 920分/月（今後15分間隔に変更しても対応可能）

### ユーザー操作
- 自動リロードなし → **手動リロード必須**
- 最新データは更新から3〜5分後に反映
- **24時間いつでも当日のデータが閲覧可能**

### システムの利点
- **24時間運用:** 深夜でも当日のデータが見られる
- **テスト運用:** 1時間間隔で安定性を確認中
- サーバーレス（コスト削減）
- GitHub Actionsで自動化
- GitHub Pagesで高速配信
- GitHub Actions無料枠に十分な余裕あり（54%消費）

### システムの制約
- リアルタイム更新ではない（1時間間隔 - テスト中）
- GitHub Actions無料枠の制約（月間2,000分）
- 手動リロードが必要
- 早朝はレース詳細情報が少ない可能性

### 今後の運用予定
1. **テスト期間:** 1時間間隔で安定性・データ品質を確認
2. **本番運用:** 安定性確認後、レース開催時間（10:00-17:00）を15分間隔に変更
3. **実行時間の監視:** GitHub Actionsの使用時間を定期的にチェック
4. **エラーハンドリング強化:** スクレイピング失敗時のリトライ機能
5. **データキャッシュ:** 変更がない場合はコミットをスキップしてGitHub Actions時間を節約
