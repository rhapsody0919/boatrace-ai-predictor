# ボートレースAI予想サイト - システム動作仕様

## 概要

本システムは、GitHub ActionsとVercelを使用した静的サイトで、**24時間を通して当日のレースデータとAI予想、的中率統計を提供**します。

**現在の運用状態: テスト中（1時間間隔で24時間実行）**

**主要機能:**
- レース情報の自動取得と3モデルAI予想生成（スタンダード・本命狙い・穴狙い）
- レース結果と払戻金の自動スクレイピング
- 的中率と回収率の自動計算と統計表示
- 会場別・モデル別の統計分析と推奨モデル提案

---

## 🔄 システムアーキテクチャ

### データフロー

```
┌─────────────────────────────────────────────────────────────┐
│ GitHub Actions (1時間ごと実行)                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. レース情報取得 (scrape-to-json.js)                        │
│     ↓                                                         │
│     boatrace.jp → data/races.json                           │
│                                                               │
│  2. AI予想生成 (generate-predictions.js)                      │
│     ↓                                                         │
│     data/races.json → data/predictions/YYYY-MM-DD.json      │
│     (3モデル: standard/safeBet/upsetFocus + 荒れ度スコア)   │
│                                                               │
│  3. レース結果取得 (scrape-results.js)                        │
│     ↓                                                         │
│     boatrace.jp → data/predictions/YYYY-MM-DD.json (更新)   │
│     (着順 + 払戻金データ)                                    │
│                                                               │
│  4. 的中率・回収率計算 (calculate-accuracy.js)                │
│     ↓                                                         │
│     data/predictions/*.json → data/predictions/summary.json │
│     (モデル別・会場別・券種別の統計)                         │
│                                                               │
│  5. データをpublic/data/にコピー (Vercel用)                  │
│     ↓                                                         │
│  6. Git コミット & プッシュ                                    │
│     ↓                                                         │
│  7. Vercel Deploy Hook トリガー                              │
│     ↓                                                         │
│  8. Vercel 自動デプロイ                                       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────────────────────┐
│ ユーザーのブラウザ (Vercel経由)                                │
├─────────────────────────────────────────────────────────────┤
│  - Vite + React フロントエンド                                │
│  - 3モデルの予想切り替え表示                                   │
│  - 荒れ度スコアと推奨モデルの表示                              │
│  - レース一覧とAI予想を表示                                    │
│  - 的中率・回収率ダッシュボードを表示                          │
│  - ブログ、FAQ、使い方ページなどのコンテンツ                  │
└─────────────────────────────────────────────────────────────┘
```

### ファイル構造

```
boatrace-ai-predictor/
├── data/
│   ├── races.json                      # 今日のレース情報
│   └── predictions/
│       ├── 2025-12-03.json            # 日付ごとのAI予想と結果
│       ├── 2025-12-04.json
│       ├── 2025-12-05.json
│       └── summary.json               # 的中率・回収率統計サマリー
├── public/data/                        # Vercel用データコピー先
│   ├── races.json
│   └── predictions/
│       └── ...
├── scripts/
│   ├── scrape-to-json.js              # レース情報スクレイピング
│   ├── generate-predictions.js        # 3モデルAI予想生成
│   ├── scrape-results.js              # レース結果・払戻金スクレイピング
│   ├── calculate-accuracy.js          # 的中率・回収率計算
│   ├── update-google-sheets.js        # Google Sheets連携
│   └── send-email-notification.js     # メール通知
├── src/                                # Reactフロントエンド
│   ├── App.jsx                        # メインアプリ
│   ├── AppRouter.jsx                  # ルーティング設定
│   ├── components/                    # コンポーネント
│   │   ├── AccuracyDashboard.jsx     # 的中率ダッシュボード
│   │   ├── HitRaces.jsx              # 的中レース一覧
│   │   ├── UpdateStatus.jsx          # 更新状態表示
│   │   └── ...
│   └── pages/                         # ページ
│       ├── About.jsx                 # About
│       ├── Blog.jsx                  # ブログ一覧
│       ├── BlogPost.jsx              # ブログ記事
│       ├── FAQ.jsx                   # FAQ
│       └── HowToUse.jsx              # 使い方
├── .github/workflows/
│   └── scrape.yml                     # 自動実行スケジュール
├── index.html                          # HTMLエントリーポイント
├── vite.config.js                      # Vite設定
└── package.json                        # 依存関係
```

---

## 📅 日次スケジュール

### 🕐 24時間スクレイピング（テスト運用）

**GitHub Actionsの動作:**
```yaml
# テスト中: 1時間間隔で24時間実行
cron: '0 * * * *'
```

**実行スケジュール:**
```
0:00, 1:00, 2:00, 3:00, 4:00, 5:00, 6:00, 7:00, 8:00, 9:00,
10:00, 11:00, 12:00, 13:00, 14:00, 15:00, 16:00, 17:00,
18:00, 19:00, 20:00, 21:00, 22:00, 23:00
（1時間間隔で24回実行）
```

**データの状態:**
- **当日のレースデータ**が表示される
- 深夜0:00の初回スクレイピングで、その日開催予定のレース場リストを取得
- レース詳細情報がまだ公開されていない場合は空配列、または基本情報のみ

**画面の表示:**
```
レースデータを読み込み中...
↓
【パターン1: レース情報が公開されている場合】
本日開催予定のレース場と基本情報を表示
（天候・気温などの詳細はまだ null の可能性あり）

【パターン2: レース情報がまだ公開されていない場合】
「本日、このレース場での開催はありません」
または空のデータ（data: []）
```

**処理内容:**
1. **レース情報取得** `scripts/scrape-to-json.js`が実行される
   - https://www.boatrace.jp/owpc/pc/race/index から本日開催中のレース場リストを取得
   - 各レース場の1R〜12Rのデータを並列取得（会場間は1秒の遅延）
   - `data/races.json`にデータを保存

2. **AI予想生成** `scripts/generate-predictions.js`が実行される
   - `data/races.json`を読み込み
   - 各レースの選手データからAIスコアを計算
   - 本命（トップピック）とトップ3を予想
   - `data/predictions/YYYY-MM-DD.json`に保存

3. **レース結果取得** `scripts/scrape-results.js`が実行される
   - 今日の予想ファイル（`data/predictions/YYYY-MM-DD.json`）を読み込み
   - 各レースの結果ページをスクレイピング
   - **既に結果があるレースはスキップ**（効率化）
   - 各リクエスト間に500msの遅延（サーバー負荷軽減）
   - 1-2-3着の艇番を取得して予想ファイルに追記

4. **的中率計算** `scripts/calculate-accuracy.js`が実行される
   - 全ての予想ファイル（`data/predictions/*.json`）を読み込み
   - 各レースの予想と結果を比較
   - 本命的中率、トップ3的中率を計算
   - 前日、今月、先月の統計を集計
   - `data/predictions/summary.json`に保存

5. **Git コミット & プッシュ**
   - 変更があった場合のみコミット

6. **GitHub Pages 自動デプロイトリガー**

**データの状態:**
```json
{
  "success": true,
  "data": [
    {
      "placeCd": 3,
      "placeName": "江戸川",
      "races": [
        {
          "date": "2025-11-28",
          "placeCd": 3,
          "raceNo": 1,
          "weather": "晴",
          "airTemp": 18.5,
          "windDirection": 2,
          "windVelocity": 3.2,
          "waterTemp": 16.8,
          "waveHeight": 2
        }
        // ... 最大12レース分
      ]
    }
    // ... 開催中の全会場（通常10〜12会場）
  ],
  "scrapedAt": "2025-11-28T01:00:00.000Z"  // UTC時刻（JST 10:00）
}
```

**デプロイ完了時刻:**
- スクレイピング: 約1〜2分
- デプロイ: 約2〜3分
- **合計: スクレイピング開始から3〜5分後にサイトが更新される**

**データ更新の流れ:**
1. 1時間ごとにスクレイピング実行
2. 最新のレース情報（天候、気温、風速など）を取得
3. `data/races.json`を上書き更新
4. 自動コミット＆プッシュ
5. GitHub Pagesが自動再デプロイ
6. **数分後にユーザーがリロードすると最新データが表示される**

**ユーザーの操作:**
- **重要:** ページは自動リロードされない
- 最新データを見るには**手動でリロード（F5またはCmd+R）が必要**

**ユーザー体験:**
- 0:00以降、当日の日付のデータが表示される
- 早朝はレース詳細情報が少ない可能性がある
- 1時間ごとに更新されるため、リロードすると徐々に情報が増える
- レース開催中（10:00-17:00頃）も1時間間隔で更新
- 夕方以降も当日のレースデータが保持される

---

## 🔄 データの鮮度について

### データ更新の遅延要因

1. **スクレイピング処理時間:** 約1〜2分
   - 会場数: 10〜12会場
   - 1会場あたり12レースを並列取得
   - 会場間の遅延: 1秒

2. **Git処理時間:** 約10〜20秒
   - コミット作成
   - GitHub へのプッシュ

3. **GitHub Pagesデプロイ時間:** 約2〜3分
   - ビルド処理
   - CDNへの配信

**合計遅延:** 約3〜5分

### 実際のユーザー体験

例: JST 10:00にスクレイピング開始の場合

```
10:00:00  GitHub Actions開始
10:01:30  スクレイピング完了、data/races.jsonに保存
10:01:40  Gitコミット＆プッシュ完了
10:01:45  GitHub Pagesデプロイ開始
10:04:30  デプロイ完了、サイトに最新データが反映

→ ユーザーが10:05にアクセスしてリロードすると最新データが見られる
→ 次回更新は11:00（1時間後）
```

---

## 📊 画面の状態遷移

### パターン1: 早朝にアクセス（7:00）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 当日のレースデータを表示
   （7:00頃にスクレイピングされたデータ）
   ↓
5. ドロップダウンに本日開催予定の会場が表示される
   （詳細情報はまだ少ない可能性あり）
```

### パターン2: 午前中にアクセス（10:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 10:00頃にスクレイピングされたデータを表示
   ↓
5. ドロップダウンに本日開催中の会場のみが表示される
   （例: 江戸川、浜名湖、常滑、津、住之江、鳴門、丸亀、徳山、若松、福岡、大村）
   ↓
6. 天候・気温・風速などの詳細情報が充実している
   ↓
7. 次回更新は11:00（1時間後）
```

### パターン3: 夕方にアクセス（18:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 18:00頃にスクレイピングされたデータを表示
   （本日のレース結果含む）
   ↓
5. 日付は本日、当日の全レースデータが表示される
   ↓
6. 次回更新は19:00（1時間後）
```

### パターン4: 深夜にアクセス（0:30）

```
1. ページ読み込み開始
   ↓
2. "レースデータを読み込み中..." 表示
   ↓
3. /data/races.json を取得
   ↓
4. 0:00頃にスクレイピングされた当日のデータを表示
   （まだレース詳細情報は少ない）
   ↓
5. 日付は本日だが、詳細情報は翌朝以降に充実する
   ↓
6. 次回更新は1:00（1時間後）
```

---

## 🎯 ユーザーへの推奨事項

### 最適なアクセス時間
- **0:00以降:** 当日のデータが表示される（詳細情報は少ない）
- **10:00以降:** レース詳細情報が充実し始める
- **レース開催中（10:00〜17:00）:** 1時間間隔で更新される（テスト中）
- **18:00以降:** レース結果の確認が可能

### データの鮮度を確認する方法
- ページ下部に表示される `scrapedAt` タイムスタンプを確認
- 例: `最終更新: 2025-11-28T01:15:00.000Z`（JST 10:15に相当）

### 最新データを取得するには
1. ブラウザをリロード（F5 または Cmd+R）
2. キャッシュクリアしてリロード（Ctrl+Shift+R または Cmd+Shift+R）

---

## ⚙️ 技術的な制約事項

### GitHub Actions無料プランの制限

- **月間実行時間:** 2,000分

**本システムの月間消費見込み（テスト運用: 1時間間隔で24時間）:**
```
【1日あたりの実行回数】
- 0:00-23:00: 1時間間隔 × 24回 = 24回/日

【月間消費時間の計算】
- 1回あたりの実行時間: 約1.5分（実測値）
- 月間消費: 24回 × 1.5分 × 30日 = 1,080分
- **制限内に十分収まる（2,000分の約54%）**

【安全マージン】
- 制限まで残り: 2,000分 - 1,080分 = 920分
- 実行時間が多少長くなっても余裕がある
- 今後15分間隔に変更しても対応可能
```

**本番運用時の推奨設定（15分間隔）:**
```
【1日あたりの実行回数（参考）】
- 0:00-9:00:   1時間間隔 × 10回 = 10回
- 10:00-17:00: 15分間隔 × 28回 = 28回
- 18:00-23:00: 1時間間隔 × 6回  = 6回
合計: 44回/日

【月間消費時間】
- 月間消費: 44回 × 1.5分 × 30日 = 1,980分
- ギリギリ制限内（2,000分の99%）
```

**制限を超えた場合の対策:**
1. レース開催時間（10:00-17:00）の間隔を30分に変更
2. 深夜・早朝の実行間隔を2時間に変更
3. 手動でワークフローを停止し、翌月まで待つ

### データ更新の仕組み
- **静的サイト:** サーバーサイド処理なし
- **データソース:** `/data/races.json`（Gitリポジトリにコミット）
- **更新トリガー:** GitHub Actionsのcron（1時間間隔で24時間実行 - テスト中）

### レート制限対策
- 会場間の取得に1秒の遅延を設定
- User-Agent: `BoatraceAIBot/1.0 (+https://github.com/rhapsody0919/boatrace-ai-predictor)`
- タイムアウト: 5秒

---

## 🛠️ トラブルシューティング

### 問題1: 「本日、このレース場での開催はありません」と表示される

**原因:**
- 早朝（0:00-6:00）でレース情報がまだ公開されていない
- GitHub Actionsが失敗している
- デプロイが遅延している
- 実際にレースが開催されていない日

**対処法:**
1. 時間を置いて（1-2時間後）再度アクセス
2. GitHub Actionsの実行ログを確認: https://github.com/rhapsody0919/boatrace-ai-predictor/actions
3. ブラウザキャッシュをクリアしてリロード
4. boatrace.jp で実際に開催があるか確認

### 問題2: データが古い（前日のデータが表示される）

**原因:**
- GitHub Actionsのスケジュール実行が失敗
- リポジトリの権限不足
- データ取得元サイト（boatrace.jp）がメンテナンス中
- 深夜0:00のスクレイピングがまだ実行されていない

**対処法:**
1. https://github.com/rhapsody0919/boatrace-ai-predictor/actions でワークフロー実行状況を確認
2. 手動でワークフローを実行（workflow_dispatch）
3. エラーログを確認して原因を特定
4. 0:05以降に再度アクセス（深夜0:00のスクレイピング完了後）

### 問題3: 特定の会場のデータが欠けている

**原因:**
- その会場のスクレイピングがタイムアウト
- 会場のページ構造が変更された
- 一時的なネットワークエラー

**対処法:**
1. 次回更新を待つ（レース開催中なら15分後、それ以外は1時間後）
2. GitHub Actionsのログで該当会場のエラーを確認
3. 必要に応じてスクレイピングロジックを修正

### 問題4: GitHub Actions無料枠を使い切った

**症状:**
- スケジュール実行が停止する
- データが更新されなくなる

**原因:**
- 月間2,000分の制限を超過

**対処法:**
1. GitHub Actionsのページで使用状況を確認
2. 翌月1日まで待つ（自動的にリセットされる）
3. 緊急時は手動でワークフローを実行（workflow_dispatch）
4. 長期的には実行間隔を調整（30分間隔、1時間間隔など）

---

## 📝 まとめ

### データ更新サイクル（テスト運用中）
- **0:00-23:00:** 1時間間隔で更新（24回/日）
- **合計:** 24回/日、月間1,080分（GitHub Actions無料枠の54%）
- **余裕:** 920分/月（今後15分間隔に変更しても対応可能）

### ユーザー操作
- 自動リロードなし → **手動リロード必須**
- 最新データは更新から3〜5分後に反映（Vercelデプロイ完了後）
- **24時間いつでも当日のデータが閲覧可能**
- **3モデルの切り替え表示可能**（スタンダード・本命狙い・穴狙い）

### システムの利点
- **24時間運用:** 深夜でも当日のデータが見られる
- **3モデルAI予想:** レース展開に応じた最適な予想を提供
- **回収率最適化:** 会場別・モデル別の収益性を分析し推奨を提示
- **テスト運用:** 1時間間隔で安定性を確認中
- **Vercelホスティング:** 高速配信とグローバルCDN対応
- **Vite + React:** モダンなフロントエンドで快適なUI/UX
- **SEO最適化:** OGP、構造化データ、sitemap対応
- サーバーレス（コスト削減）
- GitHub Actionsで自動化
- GitHub Actions無料枠に十分な余裕あり（54%消費）

### システムの制約
- リアルタイム更新ではない（1時間間隔 - テスト中）
- GitHub Actions無料枠の制約（月間2,000分）
- 手動リロードが必要
- 早朝はレース詳細情報が少ない可能性

### 追加機能
- **ブログ機能:** 競艇予想のコツやレース分析記事を公開
- **FAQ:** よくある質問と回答
- **使い方ガイド:** システムの使用方法を詳細に説明
- **Google Sheets連携:** データをスプレッドシートに同期（scripts/update-google-sheets.js）
- **メール通知:** 重要なイベントをメールで通知（scripts/send-email-notification.js）

### 今後の運用予定
1. **テスト期間:** 1時間間隔で安定性・データ品質を確認
2. **本番運用:** 安定性確認後、レース開催時間（10:00-17:00）を15分間隔に変更
3. **実行時間の監視:** GitHub Actionsの使用時間を定期的にチェック
4. **エラーハンドリング強化:** スクレイピング失敗時のリトライ機能
5. **データキャッシュ:** 変更がない場合はコミットをスキップしてGitHub Actions時間を節約
6. **モデル精度向上:** 実績データを基に各モデルのロジックを継続的に改善
7. **会場別特性分析:** 会場ごとの傾向を学習し、予想精度をさらに向上

---

## 📋 各スクリプトの詳細動作

### 1. レース情報取得 (scripts/scrape-to-json.js)

**実行タイミング:** 毎時0分（例: 9:00, 10:00, 11:00...）

**処理フロー:**
```
1. boatrace.jp のトップページから開催中の会場リストを取得
2. 各会場（通常10-12会場）について:
   - 1R〜12Rの詳細情報をスクレイピング
   - 選手データ（級別、勝率、モーター・ボート成績など）
   - 天候データ（気温、風速、風向、波高など）
   - 会場間に1秒の遅延を設定（レート制限対策）
3. 全データを data/races.json に統合して保存
4. 実行時間: 約1-2分
```

**出力ファイル:** `data/races.json`

**データ例:**
```json
{
  "success": true,
  "data": [
    {
      "placeCd": 1,
      "placeName": "桐生",
      "races": [
        {
          "date": "2025-12-05",
          "placeCd": 1,
          "raceNo": 1,
          "startTime": "15:24",  // 締切予定時刻
          "weather": "晴",
          "airTemp": 8,
          "windDirection": 4,
          "windVelocity": 2,
          "waterTemp": 12,
          "waveHeight": 2,
          "racers": [
            {
              "lane": 1,  // 1-6の艇番
              "name": "選手名",
              "grade": "A1",
              "age": 35,  // 年齢
              "globalWinRate": 7.50,  // 全国勝率
              "global2Rate": 42.5,    // 全国2連率
              "localWinRate": 8.20,   // 当地勝率
              "local2Rate": 48.3,     // 当地2連率
              "motorNumber": 42,
              "motor2Rate": 45.2,     // モーター2連率
              "boatNumber": 15,
              "boat2Rate": 38.5       // ボート2連率
            }
            // ... 6艇分
          ]
        }
        // ... 12レース分
      ]
    }
    // ... 全会場分
  ],
  "scrapedAt": "2025-12-05T00:15:32.123Z"
}
```

---

### 2. AI予想生成 (scripts/generate-predictions.js)

**実行タイミング:** レース情報取得の直後

**処理フロー:**
```
1. data/races.json を読み込み
2. 各レースについて:
   a. 荒れ度スコア（volatility）を計算（0-100点）:
      - 選手間の実力差（標準偏差が小さいほど高スコア）
      - 1号艇の弱さ（弱いほど高スコア）
      - モーター性能の均等さ（均等なほど高スコア）
      - 外枠の好機材（多いほど高スコア）
      - 競艇場特性（荒れやすい場は高スコア）

   b. 荒れ度レベルを判定:
      - low (0-34): 堅い展開
      - medium (35-64): 標準的
      - high (65-100): 荒れる展開

   c. 推奨モデルを判定:
      - 堅い → safeBet（本命狙い）
      - 標準 → standard（スタンダード）
      - 荒れる → upsetFocus（穴狙い）

   d. 3つのモデルで予想を生成:
      【スタンダードモデル】
      - 全国勝率 × 100 + ローカル2連率 × 50
      - モーター2連率 × 30 + ボート2連率 × 20
      - 枠番補正 -5 × (枠番 - 1)

      【本命狙いモデル】
      - 1号艇に+150ボーナス、A1級に+120、A2級に+60
      - 全国勝率 × 130、当地勝率 × 80
      - モーター2連率 × 40、枠番ペナルティ -15

      【穴狙いモデル】
      - 4-6号艇に+100ボーナス、1号艇に-100ペナルティ
      - モーター2連率 × 180、ボート2連率 × 80
      - 当地勝率 × 100、全国勝率 × 50（控えめ）

   e. 各モデルのトップピック・トップ3を決定

   f. 予想理由を生成（モデルごとに異なる観点）

3. 日付ごとのファイルに保存: data/predictions/YYYY-MM-DD.json
   - predictions.standard, predictions.safeBet, predictions.upsetFocus
   - volatility: { score, level, recommendedModel, reasons }
   - 後方互換性のため prediction フィールドも維持（standardと同じ）

4. 実行時間: 約5-10秒
```

**出力ファイル:** `data/predictions/2025-12-05.json`

**データ例:**
```json
{
  "date": "2025-12-05",
  "generatedAt": "2025-12-05T00:15:45.234Z",
  "updatedAt": "2025-12-05T00:15:45.234Z",
  "races": [
    {
      "raceId": "2025-12-05-01-01",
      "venue": "桐生",
      "venueCode": 1,
      "raceNumber": 1,
      "startTime": "15:24",

      "volatility": {
        "score": 42,
        "level": "medium",
        "recommendedModel": "standard",
        "reasons": [
          "1号艇が平均より12%弱い（グレード: A2、勝率: 5.8%）",
          "モーター性能が均等（2連率の標準偏差: 8.3%）"
        ]
      },

      "predictions": {
        "standard": {
          "topPick": 1,
          "top3": [1, 4, 3],
          "confidence": 76,
          "players": [...],
          "reasoning": [
            "1号艇 選手名を本命に選定",
            "全国勝率7.50の実力者、モーター2連率45.2%の好機材で総合評価が最高"
          ]
        },
        "safeBet": {
          "topPick": 1,
          "top3": [1, 2, 4],
          "confidence": 82,
          "players": [...],
          "reasoning": [
            "1号艇 選手名を本命に選定",
            "1号艇の有利なコース取り、A2級選手として堅実な実績により的中率が期待できる"
          ]
        },
        "upsetFocus": {
          "topPick": 4,
          "top3": [4, 3, 1],
          "confidence": 71,
          "players": [...],
          "reasoning": [
            "4号艇 選手名を本命に選定",
            "4号艇ながらモーター2連率48.5%の好機材、好モーターを活かした高配当の可能性"
          ]
        }
      },

      // 後方互換性のため（standardと同じ内容）
      "prediction": {
        "topPick": 1,
        "top3": [1, 4, 3],
        "confidence": 76,
        "players": [...],
        "reasoning": [...]
      },

      "result": {
        "finished": false,
        "rank1": null,
        "rank2": null,
        "rank3": null,
        "payouts": null,
        "updatedAt": null
      },
      "accuracy": {
        "topPickHit": null,
        "top3Hit": null,
        "top3Included": null
      }
    }
    // ... 全レース分
  ]
}
```

**重要な仕様:**
- 荒れ度スコア（volatility）は0-100点で評価
- 3つのモデル（standard/safeBet/upsetFocus）で異なるロジックを使用
- 各モデルはAIスコア計算式が異なり、得意とする展開が違う

---

### 2-1. AIスコア算出方法の詳細

#### 📊 AIスコアとは

各艇（選手）の勝利可能性を数値化したスコアです。各モデルは異なる要素を重視してスコアを計算し、スコアが高い順に「本命」「2着候補」「3着候補」を選定します。

#### 🎯 スタンダードモデル (standard) - v2（統計的最適化版）

**コンセプト:** バランス重視、全般的に使える万能型

**統計的根拠:**
- 2,172レースの実データ分析に基づいた係数設定
- 枠番の影響: 1号艇は6号艇の22倍勝ちやすい
- 全国勝率の影響: 10倍の差がある（最重要指標）
- 級別の影響: A1級はB2級の5倍勝ちやすい
- モーター性能: 5.2%の差（限定的）
- 当地成績: 3.7%の差（限定的）

**スコア計算式:**
```javascript
AIスコア = 全国勝率 × 150
         + 級別ボーナス（A1=+400, A2=+250, B1=+100, B2=0）
         + 枠番補正（1号艇=+500, 2号艇=+100, 3号艇=0, 4号艇=-50, 5号艇=-100, 6号艇=-150）
         + モーター2連率 × 20
         + ボート2連率 × 10
         + 当地アドバンテージ × 10

※当地アドバンテージ = 当地勝率 - 全国勝率
```

**計算例（1号艇・A1級の場合）:**
```
選手データ:
- 級別: A1
- 全国勝率: 7.50
- 当地勝率: 7.80（アドバンテージ: +0.30）
- モーター2連率: 42.0
- ボート2連率: 38.5
- 枠番: 1 (index=0)

AIスコア = 7.50 × 150 + 400 + 500 + 42.0 × 20 + 38.5 × 10 + 0.30 × 10
         = 1125 + 400 + 500 + 840 + 385 + 3
         = 3253点
```

**計算例（4号艇・A2級の場合）:**
```
選手データ:
- 級別: A2
- 全国勝率: 5.80
- 当地勝率: 5.50（アドバンテージ: -0.30）
- モーター2連率: 48.5
- ボート2連率: 35.2
- 枠番: 4 (index=3)

AIスコア = 5.80 × 150 + 250 + (-50) + 48.5 × 20 + 35.2 × 10 + (-0.30) × 10
         = 870 + 250 - 50 + 970 + 352 - 3
         = 2389点
```

**特徴:**
- **枠番の影響を最重視**（統計で22倍差を確認）
- **全国勝率を従来より1.5倍重視**（統計で10倍差を確認）
- **級別を新規追加**（統計で5倍差を確認）
- モーター性能の係数を削減（統計で影響が限定的と判明）
- 当地成績の係数を大幅削減（統計で影響が小さいと判明）
- **期待される効果: 回収率132% → 150%程度に向上**

---

#### 🛡️ 本命狙いモデル (safeBet)

**コンセプト:** 堅実型、高い的中率を追求

**スコア計算式:**
```javascript
AIスコア = 1号艇ボーナス 150（1号艇の場合のみ）
         + A1級ボーナス 120（A1級の場合）
         + A2級ボーナス 60（A2級の場合）
         + 全国勝率 × 130
         + 当地勝率 × 80
         + モーター2連率 × 40
         - 枠番ペナルティ 15 × (枠番 - 1)
```

**計算例（1号艇・A1級の場合）:**
```
選手データ:
- 級別: A1
- 全国勝率: 7.50
- 当地勝率: 8.20
- モーター2連率: 42.0
- 枠番: 1 (index=0)

AIスコア = 150 + 120 + 7.50 × 130 + 8.20 × 80 + 42.0 × 40 - 15 × 0
         = 150 + 120 + 975 + 656 + 1680 - 0
         = 3581点
```

**計算例（4号艇・A2級の場合）:**
```
選手データ:
- 級別: A2
- 全国勝率: 5.80
- 当地勝率: 6.10
- モーター2連率: 48.5
- 枠番: 4 (index=3)

AIスコア = 0 + 60 + 5.80 × 130 + 6.10 × 80 + 48.5 × 40 - 15 × 3
         = 60 + 754 + 488 + 1940 - 45
         = 3197点
```

**特徴:**
- **1号艇に大きなボーナス（+150点）**
- **A1級選手を優遇（+120点）、A2級も加点（+60点）**
- 全国勝率を最重視（係数130）
- 枠番ペナルティが強め（-15点/枠）
- **的中率重視、配当は控えめ**

---

#### 🎰 穴狙いモデル (upsetFocus)

**コンセプト:** 高配当型、外枠の逆転を狙う

**スコア計算式:**
```javascript
AIスコア = 外枠ボーナス 100（4-6号艇の場合）
         + 1号艇ペナルティ -100（1号艇の場合）
         + モーター2連率 × 180
         + ボート2連率 × 80
         + 当地勝率 × 100
         + ローカル2連率 × 60
         + 全国勝率 × 50
```

**計算例（4号艇の場合）:**
```
選手データ:
- 全国勝率: 5.80
- 当地勝率: 6.10
- ローカル2連率: 38.2
- モーター2連率: 48.5
- ボート2連率: 42.0
- 枠番: 4 (index=3)

AIスコア = 100 + 0 + 48.5 × 180 + 42.0 × 80 + 6.10 × 100 + 38.2 × 60 + 5.80 × 50
         = 100 + 8730 + 3360 + 610 + 2292 + 290
         = 15382点
```

**計算例（1号艇の場合）:**
```
選手データ:
- 全国勝率: 7.50
- 当地勝率: 8.20
- ローカル2連率: 48.3
- モーター2連率: 42.0
- ボート2連率: 38.5
- 枠番: 1 (index=0)

AIスコア = 0 - 100 + 42.0 × 180 + 38.5 × 80 + 8.20 × 100 + 48.3 × 60 + 7.50 × 50
         = -100 + 7560 + 3080 + 820 + 2898 + 375
         = 14633点
```

**特徴:**
- **4-6号艇に大きなボーナス（+100点）**
- **1号艇にペナルティ（-100点）**
- **モーター性能を最重視（係数180）**
- 当地適性（地元の利）を重視
- 全国勝率は控えめに評価（係数50）
- **的中率は低めだが、当たれば高配当**

---

#### 🌊 荒れ度スコア (volatility)

レース展開の波乱度を0-100点で評価し、推奨モデルを判定します。

**スコア計算要素:**

1. **実力差の小ささ（最重要）** - 最大40点
   ```
   勝率の標準偏差が小さい（選手が拮抗している）ほど高スコア
   計算式: max(0, (1.5 - 標準偏差) × 20)
   ```

2. **1号艇の弱さ** - 最大45点
   ```
   - A1級でない: +20点
   - 全国勝率 < 6.0: +15点
   - 全国勝率 < 5.5: +10点（追加）
   ```

3. **モーター性能の均等さ** - 最大22点
   ```
   モーター2連率の標準偏差が小さい（性能が均等）ほど高スコア
   計算式: max(0, (15 - 標準偏差) × 1.5)
   ※標準偏差 < 12%の場合のみ加点
   ```

4. **外枠の好機材** - 最大24点
   ```
   4-6号艇でモーター2連率 > 40%の艇数 × 8点
   （最大3艇で24点）
   ```

5. **競艇場特性** - 12点
   ```
   荒れやすい競艇場の場合に加点:
   - 戸田(02): +12点
   - 江戸川(03): +12点
   - 平和島(04): +12点
   ```

**荒れ度レベルと推奨モデル:**
```
0-34点:   low (堅い)     → safeBet（本命狙い）推奨
35-64点:  medium (標準)  → standard（スタンダード）推奨
65-100点: high (荒れる)  → upsetFocus（穴狙い）推奨
```

**計算例:**
```
レース状況:
- 勝率の標準偏差: 1.2 → (1.5 - 1.2) × 20 = 6点
- 1号艇: A2級、勝率5.8 → 20 + 15 = 35点
- モーター標準偏差: 8.3 → (15 - 8.3) × 1.5 = 10点
- 外枠好機材: 4号艇(48.5%)、6号艇(42.1%) → 2艇 × 8 = 16点
- 競艇場: 江戸川 → 12点

荒れ度スコア = 6 + 35 + 10 + 16 + 12 = 79点
荒れ度レベル = high（荒れる）
推奨モデル = upsetFocus（穴狙い）
```

---

#### 🎓 信頼度 (confidence)

予想の確実性を70-95%で評価します。

**計算式:**
```javascript
スコア差 = 1位のAIスコア - 2位のAIスコア
信頼度 = min(95, max(70, 70 + floor(スコア差 / 10)))
```

**例:**
- スコア差 = 250点 → 信頼度 = 70 + 25 = 95%
- スコア差 = 100点 → 信頼度 = 70 + 10 = 80%
- スコア差 = 30点 → 信頼度 = 70 + 3 = 73%

**意味:**
- **95%:** 1位と2位のスコア差が大きく、本命が明確
- **70%:** 1位と2位が接戦、展開次第で逆転の可能性

---

### 3. レース結果取得 (scripts/scrape-results.js)

**実行タイミング:** AI予想生成の直後

**処理フロー:**
```
1. 今日の予想ファイル data/predictions/YYYY-MM-DD.json を読み込み

2. 各レースについて:
   a. 既に result.finished === true かつ払戻金データがある場合 → スキップ

   b. まだ結果がない、または払戻金がない場合:
      - boatrace.jp の結果ページをスクレイピング
      - URL: https://www.boatrace.jp/owpc/pc/race/raceresult?rno={raceNo}&jcd={venueCode}&hd={YYYYMMDD}
      - 1-2-3着の艇番を取得
      - 払戻金データを取得:
        * 単勝（win）
        * 複勝（place）
        * 3連複（trifecta）
        * 3連単（trio）

   c. 500ms待機（サーバー負荷軽減）

3. 取得した結果を予想ファイルに追記:
   - result.finished = true
   - result.rank1, rank2, rank3 = 着順の艇番
   - result.payouts = 払戻金データ
   - result.updatedAt = 現在時刻

4. ファイルに書き戻す
5. 実行時間: 初回 約60-120秒、2回目以降 約10-20秒（スキップが多い）
```

**出力:** `data/predictions/YYYY-MM-DD.json` (更新)

**更新後のデータ例:**
```json
{
  "result": {
    "finished": true,
    "rank1": 1,
    "rank2": 4,
    "rank3": 3,
    "payouts": {
      "win": {
        "1": 320
      },
      "place": {
        "1": 110,
        "4": 240
      },
      "trifecta": {
        "1-3-4": 1850
      },
      "trio": {
        "1-4-3": 5420
      }
    },
    "updatedAt": "2025-12-05T07:25:15.456Z"
  }
}
```

**効率化ポイント:**
- ✅ 既存の結果はスキップ → 2回目以降は高速
- ✅ 500ms遅延 → サーバー負荷を考慮
- ✅ 今日の日付のみ処理 → 過去データは再処理しない

---

### 4. 的中率・回収率計算 (scripts/calculate-accuracy.js)

**実行タイミング:** レース結果取得の直後

**処理フロー:**
```
1. data/predictions/ 内の全ファイル（*.json, summary.json以外）を読み込み

2. 各レースについて的中判定（3モデル全て）:
   a. 本命的中 (topPickHit):
      prediction.topPick === result.rank1

   b. 複勝的中 (topPickPlace):
      prediction.topPick === result.rank1 || rank2

   c. トップ3的中 (top3Hit / 3連複):
      prediction.top3 に rank1, rank2, rank3 が全て含まれている

   d. トップ3完全一致 (top3Included / 3連単):
      prediction.top3[0] === rank1 &&
      prediction.top3[1] === rank2 &&
      prediction.top3[2] === rank3

3. 実際の回収率を計算（4券種 × 3モデル）:
   a. 単勝（win）:
      topPick が 1着の場合、払戻金を獲得

   b. 複勝（place）:
      topPick が 1-2着の場合、払戻金を獲得

   c. 3連複（trifecta）:
      top3 が着順と一致（順不同）の場合、払戻金を獲得

   d. 3連単（trio）:
      top3 が着順と完全一致の場合、払戻金を獲得

   e. 回収率 = 総払戻金 ÷ 総投資額（100円/レース）

4. 統計を集計（3モデル個別 + 後方互換性のためstandard統計）:
   - 全体（overall）
   - 前日（yesterday）
   - 今月（thisMonth）
   - 先月（lastMonth）
   - 直近90日の日別履歴（dailyHistory）
   - 90日以前の月別履歴（monthlyHistory）
   - 会場別統計（byVenue, 24会場）
   - 会場別推奨モデル×券種（venueRecommendations）

5. data/predictions/summary.json に保存
6. 実行時間: 約5-10秒
```

**出力ファイル:** `data/predictions/summary.json`

**データ例:**
```json
{
  "lastUpdated": "2025-12-05T07:25:30.789Z",

  // モデル別統計（3モデル）
  "models": {
    "standard": {
      "overall": {
        "totalRaces": 120,
        "finishedRaces": 120,
        "topPickHits": 45,
        "topPickHitRate": 0.375,
        "topPickPlaces": 62,
        "topPickPlaceRate": 0.517,
        "top3Hits": 72,
        "top3HitRate": 0.60,
        "top3IncludedHits": 18,
        "top3IncludedRate": 0.15,
        "actualRecovery": {
          "win": { "totalInvestment": 12000, "totalPayout": 8540, "hitCount": 45, "recoveryRate": 0.712 },
          "place": { "totalInvestment": 12000, "totalPayout": 11280, "hitCount": 62, "recoveryRate": 0.940 },
          "trifecta": { "totalInvestment": 12000, "totalPayout": 18650, "hitCount": 72, "recoveryRate": 1.554 },
          "trio": { "totalInvestment": 12000, "totalPayout": 24800, "hitCount": 18, "recoveryRate": 2.067 }
        }
      },
      "yesterday": { ... },
      "thisMonth": { ... },
      "lastMonth": { ... },
      "dailyHistory": [ ... ],
      "monthlyHistory": [ ... ],
      "byVenue": {
        "1": {
          "overall": {
            "totalRaces": 12,
            "topPickHitRate": 0.42,
            "actualRecovery": { ... }
          },
          "thisMonth": { ... }
        },
        // ... 24会場分
      }
    },
    "safeBet": { ... },  // 同様の構造
    "upsetFocus": { ... }  // 同様の構造
  },

  // 会場別推奨モデル×券種
  "venueRecommendations": {
    "overall": {
      "1": { "bestModel": "safeBet", "bestBetType": "place", "recoveryRate": 1.15 },
      "2": { "bestModel": "upsetFocus", "bestBetType": "trio", "recoveryRate": 1.82 },
      // ... 24会場分
    },
    "thisMonth": {
      "1": { "bestModel": "standard", "bestBetType": "trifecta", "recoveryRate": 1.42 },
      // ... 24会場分
    }
  },

  // 後方互換性のため（standardモデルの統計）
  "overall": {
    "totalRaces": 120,
    "finishedRaces": 120,
    "topPickHits": 45,
    "topPickHitRate": 0.375,
    "topPickPlaces": 62,
    "topPickPlaceRate": 0.517,
    "top3Hits": 72,
    "top3HitRate": 0.60,
    "top3IncludedHits": 18,
    "top3IncludedRate": 0.15,
    "actualRecovery": { ... }
  },
  "yesterday": { ... },
  "thisMonth": { ... },
  "lastMonth": { ... },
  "dailyHistory": [ ... ],
  "monthlyHistory": [ ... ]
}
```

---

## ⏰ タイムライン例（ある日の動作）

### 例: 2025年12月5日（木）

```
【深夜 - 早朝】
00:00 JST - GitHub Actions 実行
├─ scrape-to-json.js: 12/5のレース情報取得（156レース）
├─ generate-predictions.js: AI予想生成
├─ scrape-results.js: レース結果チェック（まだ0件）
├─ calculate-accuracy.js: 的中率計算（12/4までのデータ）
└─ Git push → GitHub Pages デプロイ（00:03頃完了）

01:00, 02:00... 同様に実行（レース結果はまだ0件）

【レース開始前】
14:00 JST - GitHub Actions 実行
├─ scrape-to-json.js: 最新のレース情報取得
├─ generate-predictions.js: AI予想更新
├─ scrape-results.js: レース結果チェック（まだ0件）
└─ 的中率は12/4までのデータ

【レース開催中】
15:00 JST - 第1レース開始
16:00 JST - GitHub Actions 実行
├─ scrape-results.js: 結果取得開始
│   ├─ 桐生 R1: 1-2-4 ✓
│   ├─ 桐生 R2: 4-6-2 ✓
│   ├─ 戸田 R1: まだ未確定
│   └─ ... （約30-40レース結果取得）
└─ calculate-accuracy.js: 的中率更新（リアルタイム）

17:00, 18:00... 同様に実行（徐々に結果が増える）

【レース終了後】
21:00 JST - GitHub Actions 実行
├─ scrape-results.js: 全レース結果取得完了（156/156）
└─ calculate-accuracy.js: 12/5の的中率確定

【深夜】
22:00, 23:00 - 引き続き実行（変更なし、スキップが多い）
```

---

## 🎯 重要な動作仕様まとめ

### データ更新の特徴
1. **レース情報:** 毎時更新（天候・気温・選手データなどが変動）
2. **AI予想:** レース情報と同時に3モデルで再生成（荒れ度スコア付き）
3. **レース結果:** 毎時チェック、既存結果（払戻金含む）はスキップ
4. **的中率・回収率:** レース結果更新時に自動再計算（3モデル × 4券種 × 24会場）

### 3モデルAI予想システム
- **スタンダードモデル:** バランス重視、全般的に使える万能型
- **本命狙いモデル:** 1号艇重視、堅実な的中率を追求
- **穴狙いモデル:** 外枠・機材重視、高配当を狙う逆張り型
- **荒れ度スコア:** レース展開を0-100点で評価し、推奨モデルを自動提示

### 回収率計算の特徴
- **4券種対応:** 単勝・複勝・3連複・3連単の実際の払戻金を集計
- **モデル別分析:** 各モデルの券種別回収率を算出
- **会場別最適化:** 24会場ごとに最も収益性の高いモデル×券種を提案
- **期間別統計:** 全体・昨日・今月・先月・日別・月別の詳細分析

### 効率化の仕組み
- ✅ 既存データ（結果・払戻金）のスキップ機能
- ✅ リクエスト間の遅延（500ms〜1秒）
- ✅ 変更がない場合はGitコミットしない
- ✅ 今日の日付のみ処理（過去データは再処理不要）
- ✅ データをpublic/data/にコピー（Vercel用）

### GitHub Actions 実行時間
- **合計:** 約3-5分/回
- **内訳:**
  - スクレイピング: 1-2分
  - 予想生成（3モデル）: 5-10秒
  - 結果取得（払戻金含む）: 初回60-120秒、2回目以降10-20秒
  - 的中率・回収率計算（3モデル×24会場）: 5-10秒
  - データコピー: 5秒
  - Git操作: 10-20秒
  - Vercelデプロイ: 2-3分

### デプロイ先
- **本番環境:** Vercel (https://boat-ai.jp/)
- **データ保管:** GitHubリポジトリ（data/およびpublic/data/）
- **デプロイトリガー:** Vercel Deploy Hook（変更時のみ実行）

### 月間コスト（GitHub Actions 無料枠）
- **1日の実行:** 24回 × 5分 = 120分
- **月間:** 120分 × 30日 = 3,600分
- **無料枠:** 2,000分/月
- **⚠️ 超過:** 約1,600分（有料）

**注:** 現在はテスト運用中。本番では実行頻度を調整予定。
