import { useState, useEffect } from 'react'
import './App.css'

function App() {
  const [selectedRace, setSelectedRace] = useState(null)
  const [prediction, setPrediction] = useState(null)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [races, setRaces] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)

  // ç«¶è‰‡å ´IDã‹ã‚‰åå‰ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  const stadiumNames = {
    1: 'æ¡ç”Ÿ', 2: 'æˆ¸ç”°', 3: 'æ±Ÿæˆ¸å·', 4: 'å¹³å’Œå³¶', 5: 'å¤šæ‘©å·', 6: 'æµœåæ¹–',
    7: 'è’²éƒ¡', 8: 'å¸¸æ»‘', 9: 'æ´¥', 10: 'ã³ã‚ã“', 11: 'ä½ä¹‹æ±Ÿ', 12: 'å°¼å´',
    13: 'é³´é–€', 14: 'ä¸¸äº€', 15: 'å…å³¶', 16: 'å®®å³¶', 17: 'å¾³å±±', 18: 'ä¸‹é–¢',
    19: 'è‹¥æ¾', 20: 'èŠ¦å±‹', 21: 'ç¦å²¡', 22: 'å”æ´¥', 23: 'å¤§æ‘', 24: 'æ¡ç”Ÿ'
  }

  useEffect(() => {
    // Boatrace Open APIã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const fetchRaceData = async () => {
      try {
        setLoading(true)
        const response = await fetch('https://boatraceopenapi.github.io/results/v2/today.json')

        if (!response.ok) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
        }

        const data = await response.json()

        // ãƒ¬ãƒ¼ã‚¹çµæœã‹ã‚‰ã¾ã é–‹å‚¬ã•ã‚Œã¦ã„ãªã„ãƒ¬ãƒ¼ã‚¹ã‚’æŠ½å‡º
        const upcomingRaces = data.results
          .filter(race => race.race_stadium_number && race.race_number)
          .slice(0, 10) // æœ€åˆã®10ãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤º
          .map(race => ({
            id: `${race.race_stadium_number}-${race.race_number}`,
            stadiumNumber: race.race_stadium_number,
            venue: stadiumNames[race.race_stadium_number] || `ç«¶è‰‡å ´${race.race_stadium_number}`,
            raceNumber: race.race_number,
            date: race.race_date,
            weather: race.race_weather || 'æ™´ã‚Œ',
            wave: race.race_wave || 0,
            wind: race.race_wind || 0,
            temperature: race.race_temperature,
            waterTemperature: race.race_water_temperature,
            boats: race.boats || [],
            hasData: race.boats && race.boats.length > 0
          }))

        setRaces(upcomingRaces)
        setError(null)
      } catch (err) {
        console.error('APIå–å¾—ã‚¨ãƒ©ãƒ¼:', err)
        setError(err.message)
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        generateSampleRaces()
      } finally {
        setLoading(false)
      }
    }

    fetchRaceData()
  }, [])

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆAPIã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const generateSampleRaces = () => {
    const sampleRaces = Array.from({ length: 5 }, (_, idx) => ({
      id: `sample-${idx + 1}`,
      stadiumNumber: idx + 1,
      venue: stadiumNames[idx + 1],
      raceNumber: Math.floor(Math.random() * 12) + 1,
      date: new Date().toISOString().split('T')[0],
      weather: ['æ™´ã‚Œ', 'æ›‡ã‚Š', 'é›¨'][Math.floor(Math.random() * 3)],
      wave: Math.floor(Math.random() * 5) + 1,
      wind: Math.floor(Math.random() * 8) + 1,
      temperature: 20 + Math.floor(Math.random() * 10),
      boats: [],
      hasData: false
    }))
    setRaces(sampleRaces)
  }

  const analyzeRace = (race) => {
    setSelectedRace(race)
    setIsAnalyzing(true)
    setPrediction(null)

    // AIã«ã‚ˆã‚‹äºˆæƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    setTimeout(() => {
      let players

      // å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä½¿ç”¨
      if (race.hasData && race.boats && race.boats.length > 0) {
        players = race.boats.map(boat => ({
          number: boat.racer_boat_number || boat.racer_course_number,
          name: boat.racer_name || `é¸æ‰‹${boat.racer_number}`,
          racerId: boat.racer_number,
          courseNumber: boat.racer_course_number,
          startTiming: boat.racer_start_timing,
          place: boat.racer_place_number,
          // AIã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆã‚³ãƒ¼ã‚¹ç•ªå·ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã©ã‹ã‚‰ç®—å‡ºï¼‰
          aiScore: calculateAIScore(boat, race),
          winRate: 'å®Ÿãƒ‡ãƒ¼ã‚¿',
          motorWinRate: 'å®Ÿãƒ‡ãƒ¼ã‚¿',
        })).sort((a, b) => b.aiScore - a.aiScore)
      } else {
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        players = generatePlayers()
      }

      const aiPrediction = {
        topPick: players[0],
        recommended: players.slice(0, 3),
        allPlayers: players,
        confidence: Math.floor(Math.random() * 30) + 70,
        reasoning: [
          race.hasData ? 'å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ' : 'éå»10ãƒ¬ãƒ¼ã‚¹ã®å‹ç‡ãŒé«˜ã„',
          race.wind > 3 ? 'é¢¨ã®å½±éŸ¿ã‚’è€ƒæ…®' : 'ãƒ¢ãƒ¼ã‚¿ãƒ¼æˆç¸¾ãŒå„ªç§€',
          'å½“è©²ã‚³ãƒ¼ã‚¹ã§ã®å®Ÿç¸¾ã‚ã‚Š',
          race.wave > 2 ? 'æ³¢ã®çŠ¶æ…‹ã‚’è€ƒæ…®' : 'æ°—è±¡æ¡ä»¶ãŒæœ‰åˆ©',
        ],
        isRealData: race.hasData
      }
      setPrediction(aiPrediction)
      setIsAnalyzing(false)
    }, 2000)
  }

  // AIã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
  const calculateAIScore = (boat, race) => {
    let score = 70

    // ã‚³ãƒ¼ã‚¹ç•ªå·ãŒ1ãªã‚‰æœ‰åˆ©ï¼ˆã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ï¼‰
    if (boat.racer_course_number === 1) score += 15
    if (boat.racer_course_number === 2) score += 10
    if (boat.racer_course_number === 3) score += 5

    // ã‚¹ã‚¿ãƒ¼ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè‰¯ã‘ã‚Œã°åŠ ç‚¹
    if (boat.racer_start_timing && boat.racer_start_timing < 0.15) score += 10

    // é¢¨ã¨æ³¢ã®å½±éŸ¿
    if (race.wind < 3) score += 5
    if (race.wave < 2) score += 5

    // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ 
    score += Math.floor(Math.random() * 10)

    return Math.min(Math.max(score, 50), 99)
  }

  const generatePlayers = () => {
    const names = ['å±±ç”°å¤ªéƒ', 'éˆ´æœ¨æ¬¡éƒ', 'ä½è—¤ä¸‰éƒ', 'ç”°ä¸­å››éƒ', 'ä¼Šè—¤äº”éƒ', 'æ¸¡è¾ºå…­éƒ']
    return names.map((name, idx) => ({
      number: idx + 1,
      name: name,
      age: 25 + Math.floor(Math.random() * 20),
      winRate: (Math.random() * 0.3 + 0.2).toFixed(3),
      motorNumber: Math.floor(Math.random() * 100) + 1,
      motorWinRate: (Math.random() * 0.2 + 0.3).toFixed(3),
      aiScore: Math.floor(Math.random() * 40) + 60 - idx * 8,
    })).sort((a, b) => b.aiScore - a.aiScore)
  }

  return (
    <div className="app">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼åºƒå‘ŠãƒãƒŠãƒ¼ */}
      <div className="ad-banner header-ad">
        <div className="ad-content">
          ğŸ“¢ åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ (728x90) - ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹é–¢é€£åºƒå‘Š
        </div>
      </div>

      <header className="header">
        <div className="logo">
          <span className="logo-icon">ğŸš¤</span>
          <h1>ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹AIäºˆæƒ³</h1>
        </div>
        <nav className="nav">
          <button className="nav-btn active">ä»Šæ—¥ã®ãƒ¬ãƒ¼ã‚¹</button>
          <button className="nav-btn">äºˆæƒ³å±¥æ­´</button>
          <button className="nav-btn">çµ±è¨ˆ</button>
        </nav>
      </header>

      <div className="container">
        {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼åºƒå‘Š */}
        <aside className="sidebar-ad">
          <div className="ad-banner vertical-ad">
            <div className="ad-content vertical">
              ğŸ“¢<br/>åºƒå‘Š<br/>ã‚¹ãƒšãƒ¼ã‚¹<br/>(160x600)
            </div>
          </div>
        </aside>

        <main className="main-content">
          <section className="race-list-section">
            <div className="section-header">
              <h2>ğŸ æœ¬æ—¥é–‹å‚¬ä¸­ã®ãƒ¬ãƒ¼ã‚¹</h2>
              {error && (
                <div className="api-status error">
                  âš ï¸ APIã‚¨ãƒ©ãƒ¼ - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­
                </div>
              )}
              {!error && !loading && (
                <div className="api-status success">
                  âœ… å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ˆBoatrace Open APIï¼‰
                </div>
              )}
            </div>

            {loading ? (
              <div className="loading-container">
                <div className="spinner"></div>
                <p>ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            ) : (
              <div className="race-grid">
              {races.map(race => (
                <div key={race.id} className="race-card">
                  <div className="race-card-header">
                    <h3>{race.venue}</h3>
                    <div className="header-badges">
                      <span className="race-number">{race.raceNumber}R</span>
                      {race.hasData && <span className="real-data-badge">å®Ÿãƒ‡ãƒ¼ã‚¿</span>}
                    </div>
                  </div>
                  <div className="race-info">
                    <div className="info-item">
                      <span className="label">æ—¥ä»˜</span>
                      <span className="value">{race.date || 'ä»Šæ—¥'}</span>
                    </div>
                    <div className="info-item">
                      <span className="label">å¤©å€™</span>
                      <span className="value">{race.weather}</span>
                    </div>
                    <div className="info-item">
                      <span className="label">æ³¢é«˜</span>
                      <span className="value">{race.wave}cm</span>
                    </div>
                    <div className="info-item">
                      <span className="label">é¢¨é€Ÿ</span>
                      <span className="value">{race.wind}m</span>
                    </div>
                    {race.temperature && (
                      <div className="info-item">
                        <span className="label">æ°—æ¸©</span>
                        <span className="value">{race.temperature}Â°C</span>
                      </div>
                    )}
                  </div>
                  <button
                    className="predict-btn"
                    onClick={() => analyzeRace(race)}
                  >
                    AIäºˆæƒ³ã‚’è¦‹ã‚‹
                  </button>
                </div>
              ))}
              </div>
            )}
          </section>

          {/* ä¸­å¤®åºƒå‘ŠãƒãƒŠãƒ¼ */}
          <div className="ad-banner content-ad">
            <div className="ad-content">
              ğŸ“¢ åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ (728x90) - ãƒ¬ãƒ¼ã‚¹å ´é–¢é€£åºƒå‘Š
            </div>
          </div>

          {selectedRace && (
            <section className="prediction-section">
              <div className="prediction-header">
                <h2>ğŸ“Š AIäºˆæƒ³çµæœ - {selectedRace.venue} {selectedRace.raceNumber}R</h2>
                {prediction && prediction.isRealData && (
                  <span className="real-data-indicator">ğŸ”´ LIVE å®Ÿãƒ‡ãƒ¼ã‚¿åˆ†æ</span>
                )}
              </div>

              {isAnalyzing ? (
                <div className="analyzing">
                  <div className="spinner"></div>
                  <p>AIãŒåˆ†æä¸­...</p>
                  <p className="analyzing-detail">éå»ãƒ‡ãƒ¼ã‚¿ã€ãƒ¢ãƒ¼ã‚¿ãƒ¼æ€§èƒ½ã€æ°—è±¡æ¡ä»¶ã‚’è§£æã—ã¦ã„ã¾ã™</p>
                </div>
              ) : prediction && (
                <div className="prediction-result">
                  <div className="confidence-bar">
                    <div className="confidence-label">
                      AIä¿¡é ¼åº¦: <strong>{prediction.confidence}%</strong>
                    </div>
                    <div className="bar">
                      <div
                        className="bar-fill"
                        style={{ width: `${prediction.confidence}%` }}
                      ></div>
                    </div>
                  </div>

                  <div className="top-pick">
                    <h3>ğŸ¥‡ æœ¬å‘½äºˆæƒ³</h3>
                    <div className="player-card featured">
                      <div className="player-number">{prediction.topPick.number}</div>
                      <div className="player-details">
                        <h4>{prediction.topPick.name}</h4>
                        <div className="stats">
                          <span>å¹´é½¢: {prediction.topPick.age}æ­³</span>
                          <span>å‹ç‡: {prediction.topPick.winRate}</span>
                          <span>ãƒ¢ãƒ¼ã‚¿ãƒ¼: {prediction.topPick.motorWinRate}</span>
                        </div>
                      </div>
                      <div className="ai-score">
                        <div className="score-label">AIã‚¹ã‚³ã‚¢</div>
                        <div className="score-value">{prediction.topPick.aiScore}</div>
                      </div>
                    </div>
                  </div>

                  <div className="reasoning">
                    <h4>ğŸ“Œ äºˆæƒ³æ ¹æ‹ </h4>
                    <ul>
                      {prediction.reasoning.map((reason, idx) => (
                        <li key={idx}>{reason}</li>
                      ))}
                    </ul>
                  </div>

                  <div className="all-players">
                    <h4>å…¨è‰‡æƒ…å ±</h4>
                    <table className="players-table">
                      <thead>
                        <tr>
                          <th>è‰‡ç•ª</th>
                          <th>é¸æ‰‹å</th>
                          <th>å¹´é½¢</th>
                          <th>å‹ç‡</th>
                          <th>ãƒ¢ãƒ¼ã‚¿ãƒ¼</th>
                          <th>AIã‚¹ã‚³ã‚¢</th>
                        </tr>
                      </thead>
                      <tbody>
                        {prediction.allPlayers.map(player => (
                          <tr key={player.number} className={player.number <= 3 ? 'recommended' : ''}>
                            <td><strong>{player.number}</strong></td>
                            <td>{player.name}</td>
                            <td>{player.age}</td>
                            <td>{player.winRate}</td>
                            <td>{player.motorWinRate}</td>
                            <td><span className="score-badge">{player.aiScore}</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </section>
          )}
        </main>

        {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼åºƒå‘Šï¼ˆå³ï¼‰ */}
        <aside className="sidebar-ad">
          <div className="ad-banner vertical-ad">
            <div className="ad-content vertical">
              ğŸ“¢<br/>åºƒå‘Š<br/>ã‚¹ãƒšãƒ¼ã‚¹<br/>(160x600)
            </div>
          </div>
        </aside>
      </div>

      {/* ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘ŠãƒãƒŠãƒ¼ */}
      <div className="ad-banner footer-ad">
        <div className="ad-content">
          ğŸ“¢ åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ (728x90) - ãƒœãƒ¼ãƒˆç”¨å“ãƒ»ã‚°ãƒƒã‚ºåºƒå‘Š
        </div>
      </div>

      <footer className="footer">
        <p>â€»æœ¬ã‚µã‚¤ãƒˆã¯AIã«ã‚ˆã‚‹äºˆæƒ³ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€çš„ä¸­ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        <p>&copy; 2025 ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹AIäºˆæƒ³ - All Rights Reserved</p>
      </footer>
    </div>
  )
}

export default App
