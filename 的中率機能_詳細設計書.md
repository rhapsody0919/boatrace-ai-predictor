# 的中率機能 詳細設計書

## 📋 目次

1. [システム概要](#システム概要)
2. [データフロー](#データフロー)
3. [ファイル構成](#ファイル構成)
4. [詳細設計](#詳細設計)
5. [テスト計画](#テスト計画)
6. [実装順序](#実装順序)

---

## システム概要

### 目的
- 全ユーザー共通のAI予想を提供
- 予想データを永続的に保存
- レース結果と照合して的中率を計算・表示

### アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│          GitHub Actions (毎日自動実行)               │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ① レースデータスクレイピング                       │
│     scripts/scrape-to-json.js                      │
│     → data/races.json                              │
│                                                     │
│  ② AI予想生成 (NEW)                                │
│     scripts/generate-predictions.js                │
│     → data/predictions/YYYY-MM-DD.json             │
│                                                     │
│  ③ レース結果取得 (NEW)                            │
│     scripts/scrape-results.js                      │
│     → data/predictions/YYYY-MM-DD.json (更新)      │
│                                                     │
│  ④ 的中率計算 (NEW)                                │
│     scripts/calculate-accuracy.js                  │
│     → data/predictions/summary.json                │
│                                                     │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         GitHub Pages (静的ホスティング)              │
├─────────────────────────────────────────────────────┤
│                                                     │
│  フロントエンド (React)                              │
│  - data/races.json を読み込み                       │
│  - data/predictions/YYYY-MM-DD.json を読み込み      │
│  - data/predictions/summary.json を読み込み         │
│  - 予想結果を表示                                    │
│  - 的中率ダッシュボードを表示                        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## データフロー

### フロー1: 予想データの生成（毎日早朝）

```
00:00 GitHub Actions起動
  ↓
00:01 scrape-to-json.js 実行
  ↓ レースデータを取得
  ↓ data/races.json に保存
  ↓
00:05 generate-predictions.js 実行
  ↓ data/races.json を読み込み
  ↓ 各レースのAI予想を計算
  ↓ data/predictions/YYYY-MM-DD.json に保存
  ↓
00:10 Git commit & push
  ↓
00:12 GitHub Pages 自動デプロイ
```

### フロー2: レース結果の取得（毎日夜）

```
23:00 GitHub Actions起動
  ↓
23:01 scrape-results.js 実行
  ↓ 各レースの結果を取得
  ↓ data/predictions/YYYY-MM-DD.json に結果を追記
  ↓
23:05 calculate-accuracy.js 実行
  ↓ 予想と結果を照合
  ↓ 的中率を計算
  ↓ data/predictions/summary.json を更新
  ↓
23:10 Git commit & push
  ↓
23:12 GitHub Pages 自動デプロイ
```

### フロー3: ユーザーの操作

```
ユーザーがサイトにアクセス
  ↓
レース一覧を表示（data/races.json）
  ↓
「AI予想を見る」クリック
  ↓
data/predictions/YYYY-MM-DD.json を読み込み
  ↓
該当レースの予想を表示（事前に計算済み）
  ↓
的中率ダッシュボードを表示（summary.json）
```

---

## ファイル構成

### 既存ファイル

```
boatrace-ai-predictor/
├── data/
│   └── races.json                    # 既存: レースデータ
├── scripts/
│   └── scrape-to-json.js            # 既存: スクレイピング
├── src/
│   ├── App.jsx                       # 既存: メインコンポーネント
│   └── App.css                       # 既存: スタイル
└── .github/
    └── workflows/
        └── scrape-and-deploy.yml    # 既存: ワークフロー
```

### 新規追加ファイル

```
boatrace-ai-predictor/
├── data/
│   └── predictions/
│       ├── 2025-12-02.json          # NEW: 予想データ（日別）
│       ├── 2025-12-03.json          # NEW: 予想データ（日別）
│       └── summary.json             # NEW: 的中率サマリー
├── scripts/
│   ├── generate-predictions.js      # NEW: 予想生成
│   ├── scrape-results.js            # NEW: 結果取得
│   └── calculate-accuracy.js        # NEW: 的中率計算
└── .github/
    └── workflows/
        └── update-accuracy.yml      # NEW: 結果取得ワークフロー
```

---

## 詳細設計

### 1. データ構造

#### data/predictions/YYYY-MM-DD.json

```json
{
  "date": "2025-12-02",
  "generatedAt": "2025-12-02T00:05:00Z",
  "updatedAt": "2025-12-02T23:05:00Z",
  "races": [
    {
      "raceId": "2025-12-02-03-01",
      "venue": "江戸川",
      "venueCode": 3,
      "raceNumber": 1,
      "startTime": "10:30",
      "prediction": {
        "topPick": 1,
        "top3": [1, 3, 2],
        "confidence": 78,
        "players": [
          {
            "number": 1,
            "name": "山田太郎",
            "grade": "A1",
            "winRate": 6.82,
            "localWinRate": 7.15,
            "motorNumber": 42,
            "motor2Rate": 38.5,
            "boatNumber": 12,
            "boat2Rate": 35.2,
            "aiScore": 85
          }
          // ... 6艇分
        ],
        "reasoning": [
          "当地勝率が最も高い",
          "モーター2率が40%以上",
          "全国勝率が7.0以上の実力者"
        ]
      },
      "result": {
        "finished": false,
        "rank1": null,
        "rank2": null,
        "rank3": null,
        "updatedAt": null
      },
      "accuracy": {
        "topPickHit": null,
        "top3Hit": null,
        "top3Included": null
      }
    }
    // ... 他のレース
  ]
}
```

#### data/predictions/summary.json

```json
{
  "lastUpdated": "2025-12-02T23:10:00Z",
  "overall": {
    "totalRaces": 120,
    "finishedRaces": 120,
    "topPickHits": 38,
    "topPickHitRate": 0.317,
    "top3Hits": 75,
    "top3HitRate": 0.625
  },
  "yesterday": {
    "date": "2025-12-01",
    "totalRaces": 120,
    "topPickHitRate": 0.333
  },
  "thisMonth": {
    "year": 2025,
    "month": 12,
    "totalRaces": 240,
    "topPickHitRate": 0.325
  },
  "lastMonth": {
    "year": 2025,
    "month": 11,
    "totalRaces": 850,
    "topPickHitRate": 0.312
  },
  "dailyHistory": [
    {
      "date": "2025-12-01",
      "totalRaces": 120,
      "topPickHitRate": 0.333
    }
    // ... 過去30日分
  ]
}
```

---

### 2. scripts/generate-predictions.js

#### 目的
レースデータから全レースのAI予想を生成

#### 処理フロー

```javascript
1. data/races.json を読み込み
2. 各レース場、各レースについて:
   a. 選手データを取得
   b. AIスコアを計算（既存ロジック）
   c. トップピックを決定
   d. 予想根拠を生成
3. data/predictions/YYYY-MM-DD.json に保存
```

#### 実装のポイント

- **既存のAIロジックを流用**
  - `App.jsx`の`generatePlayers()`ロジックを抽出
  - `generateInsights()`ロジックを流用

- **日付の扱い**
  - 日本時間で処理（JSTタイムゾーン）
  - ファイル名は`YYYY-MM-DD`形式

---

### 3. scripts/scrape-results.js

#### 目的
レース結果をスクレイピングして予想データに追加

#### 処理フロー

```javascript
1. data/predictions/YYYY-MM-DD.json を読み込み
2. 各レースについて:
   a. 結果ページをスクレイピング
   b. 1-2-3着を取得
   c. result フィールドを更新
3. ファイルに書き戻し
```

#### スクレイピングURL

```
https://www.boatrace.jp/owpc/pc/race/raceresult
?rno={レース番号}
&jcd={場コード（2桁）}
&hd={日付（YYYYMMDD）}
```

---

### 4. scripts/calculate-accuracy.js

#### 目的
予想と結果を照合して的中率を計算

#### 処理フロー

```javascript
1. data/predictions/ 内の全JSONファイルを読み込み
2. 各レースについて:
   a. result.finished が true のものだけを対象
   b. 的中判定を実行
   c. accuracy フィールドを更新
3. 全体、昨日、今月、先月の的中率を計算
4. summary.json を生成・保存
```

#### 的中判定ロジック

```javascript
// 本命的中
topPickHit = (prediction.topPick === result.rank1)

// トップ3的中（3連複）
top3Hit = (
  prediction.top3.includes(result.rank1) &&
  prediction.top3.includes(result.rank2) &&
  prediction.top3.includes(result.rank3)
)

// トップ3完全一致（3連単）
top3Included = (
  prediction.top3[0] === result.rank1 &&
  prediction.top3[1] === result.rank2 &&
  prediction.top3[2] === result.rank3
)
```

---

### 5. フロントエンド修正

#### src/App.jsx の変更

**削除するコード**:
- `savePrediction()` 関数
- `getSavedPredictions()` 関数
- デバッグ用の useEffect
- `analyzeRace()` 内の保存処理

**追加するコード**:
- 予想データ読み込み関数
- 的中率サマリー読み込み関数

**変更するコード**:
- `analyzeRace()` - その場で生成せず、JSONから読み込み

#### 新規コンポーネント

**src/components/AccuracyDashboard.jsx**
- 的中率ダッシュボードを表示
- summary.json からデータ取得
- グラフ表示（オプション）

---

## テスト計画

### テスト1: 予想生成スクリプト

#### テストケース

| No | テスト内容 | 入力 | 期待結果 |
|----|-----------|------|----------|
| 1.1 | 正常系: レースデータから予想生成 | 有効な races.json | predictions/YYYY-MM-DD.json が作成される |
| 1.2 | 異常系: races.json が存在しない | なし | エラーメッセージを出力して終了 |
| 1.3 | 異常系: races.json が空 | `{"data": []}` | 空の predictions ファイルを生成 |
| 1.4 | 境界値: 選手データが不完全 | racers が null | ダミーデータで予想を生成 |

#### テスト実行方法

```bash
# テストデータを準備
cp data/races.json data/races_backup.json

# スクリプト実行
node scripts/generate-predictions.js

# 結果確認
cat data/predictions/$(date +%Y-%m-%d).json | jq
```

---

### テスト2: 結果取得スクリプト

#### テストケース

| No | テスト内容 | 入力 | 期待結果 |
|----|-----------|------|----------|
| 2.1 | 正常系: レース結果を取得 | 終了済みレース | result フィールドが更新される |
| 2.2 | 正常系: 未終了レース | 未終了レース | result.finished = false のまま |
| 2.3 | 異常系: スクレイピング失敗 | 無効なURL | エラーをログに出力、処理を継続 |

#### テスト実行方法

```bash
# 過去の日付でテスト
node scripts/scrape-results.js --date 2025-11-28

# 結果確認
cat data/predictions/2025-11-28.json | jq '.races[0].result'
```

---

### テスト3: 的中率計算スクリプト

#### テストケース

| No | テスト内容 | 入力 | 期待結果 |
|----|-----------|------|----------|
| 3.1 | 正常系: 的中率を計算 | 予想と結果が揃ったデータ | summary.json が作成される |
| 3.2 | 正常系: 本命的中 | topPick=1, rank1=1 | topPickHit = true |
| 3.3 | 正常系: 本命外れ | topPick=1, rank1=2 | topPickHit = false |
| 3.4 | 境界値: データが0件 | 空の predictions | エラーにならず、0件として処理 |

#### テスト実行方法

```bash
# スクリプト実行
node scripts/calculate-accuracy.js

# 結果確認
cat data/predictions/summary.json | jq
```

---

### テスト4: フロントエンド

#### テストケース

| No | テスト内容 | 操作 | 期待結果 |
|----|-----------|------|----------|
| 4.1 | 予想データ読み込み | ページ読み込み | predictions JSON を取得 |
| 4.2 | AI予想表示 | 「AI予想を見る」クリック | 事前生成された予想を表示 |
| 4.3 | 的中率表示 | ダッシュボード表示 | summary.json から的中率を表示 |
| 4.4 | エラーハンドリング | JSON取得失敗 | エラーメッセージを表示 |

#### テスト実行方法

```bash
# ローカルサーバー起動
npm run dev

# ブラウザでアクセス
# http://localhost:5173/boatrace-ai-predictor/

# 開発者ツールでネットワークタブを確認
# - data/predictions/YYYY-MM-DD.json が取得されているか
# - data/predictions/summary.json が取得されているか
```

---

## 実装順序

### フェーズ1: 予想生成スクリプト（最優先）

1. `scripts/generate-predictions.js` を作成
2. 既存のAIロジックを抽出・移植
3. ローカルでテスト実行
4. 動作確認

**成果物**: `data/predictions/YYYY-MM-DD.json`

---

### フェーズ2: GitHub Actions 統合

1. `.github/workflows/scrape-and-deploy.yml` を修正
2. 予想生成を追加
3. 手動トリガーでテスト
4. 動作確認

**成果物**: 自動デプロイされた予想データ

---

### フェーズ3: フロントエンド修正

1. localStorage コードを削除
2. 予想データ読み込みロジックを追加
3. ローカルでテスト
4. 動作確認

**成果物**: 予想を表示できるフロントエンド

---

### フェーズ4: 結果取得スクリプト

1. `scripts/scrape-results.js` を作成
2. ローカルでテスト（過去日付）
3. 動作確認

**成果物**: 結果が追記された予想データ

---

### フェーズ5: 的中率計算スクリプト

1. `scripts/calculate-accuracy.js` を作成
2. ローカルでテスト
3. 動作確認

**成果物**: `data/predictions/summary.json`

---

### フェーズ6: 的中率表示

1. `AccuracyDashboard` コンポーネント作成
2. summary.json 読み込み
3. UI表示
4. 動作確認

**成果物**: 的中率ダッシュボード

---

### フェーズ7: GitHub Actions 完全版

1. 結果取得ワークフローを追加
2. 毎日23:00に自動実行
3. 動作確認

**成果物**: 完全自動化されたシステム

---

## 次のステップ

この設計書を確認して、承認いただけたら**フェーズ1から実装を開始**します。

各フェーズごとに:
1. 実装
2. 私がテスト
3. 動作確認後、あなたに報告
4. あなたが確認
5. 次のフェーズへ

という流れで進めます。

**この設計で進めて良いですか？**
