# トークン最適化ガイド

このファイルは、Claude Codeの使用時にトークンを節約し、プラン使用制限を回避するためのベストプラクティスをまとめています。

## 🎯 基本原則

### 1. コンテキストの再利用
毎回新しい会話を始めるのではなく、`.claude/`ディレクトリのドキュメントを参照する。

**悪い例:**
```
ユーザー: "このプロジェクトについて説明してください"
Claude: [プロジェクト全体を説明 → トークン大量消費]
```

**良い例:**
```
ユーザー: ".claude/project-context.mdを参照してください"
Claude: [ファイルを読む → 最小限のトークン]
```

### 2. 具体的な指示
曖昧な指示は探索を必要とし、トークンを消費する。

**悪い例:**
```
"シェア機能を修正して"
→ Claude はシェア機能を探すために複数のファイルを読む
```

**良い例:**
```
"src/utils/share.js の generateHitRaceShareText 関数を修正して"
→ Claude は直接該当ファイルを読む
```

### 3. 段階的なアプローチ
大きなタスクは小さく分割する。

**悪い例:**
```
"サイト全体のUIを改善して"
→ 膨大なファイルを読み込み、大量のトークンを消費
```

**良い例:**
```
1. "まず src/App.jsx のヘッダー部分を改善して"
2. "次に SocialShareButtons.jsx のスタイルを改善して"
→ 各タスクが明確で、必要なファイルのみを読む
```

## 📋 効率的なプロンプトパターン

### パターン1: ファイルパス指定

```
❌ 悪い: "LINEシェアのコードを修正して"
✅ 良い: "src/components/SocialShareButtons.jsx の LineShareButton を修正して"
```

### パターン2: 関数名指定

```
❌ 悪い: "シェアテキストを変更して"
✅ 良い: "src/utils/share.js の generatePredictionShareText 関数を変更して"
```

### パターン3: 行番号指定

```
❌ 悪い: "的中メッセージのロジックを修正して"
✅ 良い: "src/utils/share.js の324-330行目のメッセージを修正して"
```

### パターン4: コンテキスト参照

```
❌ 悪い: "プロジェクトの構造を教えて"
✅ 良い: ".claude/project-context.md を参照してください"
```

## 🚀 実践的なワークフロー

### ワークフロー1: 機能修正

1. **問題を明確にする**
   ```
   "スマホでLINEシェア時にメッセージが表示されない"
   ```

2. **関連ファイルを特定する**（.claude/quick-reference.md参照）
   ```
   "src/components/SocialShareButtons.jsx を確認して"
   ```

3. **修正を依頼する**
   ```
   "LineShareButton の url プロパティに title を結合して"
   ```

4. **デプロイする**
   ```
   "変更をコミット＆プッシュして"
   ```

### ワークフロー2: 用語変更

1. **変更対象を明確にする**
   ```
   "「競艇」を「ボートレース」に変更しました"
   ```

2. **デプロイのみ依頼する**
   ```
   "コミット＆プッシュして"
   ```

3. **ルール化を依頼する**
   ```
   ".claude/project-rules.md に追記して"
   ```

## 💡 トークン消費を抑えるテクニック

### テクニック1: ドキュメント活用

**新しいタスクの前に:**
```
"まず .claude/project-context.md と .claude/quick-reference.md を確認してください"
```

これにより、Claudeはプロジェクトの構造を理解し、効率的に作業できる。

### テクニック2: ファイル探索の最小化

**Grep や Glob を使う前に:**
```
".claude/quick-reference.md の「コード検索のコツ」を参照してください"
```

よく使うパターンがドキュメント化されているため、探索が不要。

### テクニック3: 過去の修正履歴を参照

**同じような問題が発生した場合:**
```
".claude/project-context.md の「過去の重要な修正」を確認してください"
```

類似の問題解決方法が記録されている。

### テクニック4: タスクのバッチ処理

**複数の小さな変更がある場合:**
```
悪い例:
1. "ファイルAを修正して" → commit & push
2. "ファイルBを修正して" → commit & push
3. "ファイルCを修正して" → commit & push

良い例:
"ファイルA、B、Cを修正して、まとめてcommit & pushして"
```

## 📊 トークン消費の比較

### シナリオ: LINEシェアバグ修正

**非効率なアプローチ:**
1. "プロジェクトについて説明して" (500トークン)
2. "LINEシェアの実装を探して" (1000トークン、複数ファイル読み込み)
3. "問題を調査して" (1500トークン、ドキュメント検索)
4. "修正して" (300トークン)
5. "デプロイして" (200トークン)

**合計: 約3500トークン**

**効率的なアプローチ:**
1. "src/components/SocialShareButtons.jsx のLINEシェアでスマホの時メッセージが表示されない問題を修正して" (500トークン)
2. "デプロイして" (200トークン)

**合計: 約700トークン**

**節約: 約80%**

## 🎓 学習ポイント

### よくある無駄

1. **プロジェクト全体の説明を求める**
   - 代わりに: `.claude/project-context.md`を参照

2. **曖昧な指示**
   - 代わりに: ファイルパス、関数名、行番号を指定

3. **探索的な質問**
   - 代わりに: `.claude/quick-reference.md`の「よくあるタスク」を参照

4. **毎回同じコンテキストを説明**
   - 代わりに: ドキュメントに記録し、参照を依頼

### 効率的な依頼方法

**テンプレート:**
```
【背景】
.claude/project-context.md を参照してください

【タスク】
<具体的なファイルパス>:<関数名/行番号> を <どのように> 修正してください

【理由】
<なぜこの修正が必要か>（オプション）

【デプロイ】
修正後、コミット＆プッシュしてください
```

**実例:**
```
【背景】
.claude/project-context.md を参照してください

【タスク】
src/utils/share.js:324-330 の generateHitRaceShareText 関数で、
「全的中」を具体的な券種名（単勝・複勝・3連複・3連単）に変更してください

【理由】
ユーザーがどの券種が的中したかわかりやすくするため

【デプロイ】
修正後、コミット＆プッシュしてください
```

## 🔄 継続的な改善

### ドキュメントの更新

新しい重要な修正や決定事項があった場合:

1. `.claude/project-context.md` の「過去の重要な修正」に追記
2. `.claude/quick-reference.md` の該当セクションに追記
3. 必要に応じて新しいセクションを作成

### フィードバックループ

トークン消費が多いと感じた場合:

1. どの部分で時間がかかったか記録
2. `.claude/quick-reference.md` に追加
3. 次回から効率的に作業できるようにする

## 📈 トークン節約の目標

### レベル1: 基本（節約率 30-50%）
- ファイルパスを明示
- 具体的な指示

### レベル2: 中級（節約率 50-70%）
- `.claude/` ドキュメントを参照
- 関数名・行番号を指定

### レベル3: 上級（節約率 70-90%）
- タスクをバッチ処理
- 過去の修正履歴を活用
- プロンプトテンプレートを使用

## 🎯 まとめ

**トークン節約の3原則:**

1. **ドキュメントを活用** - `.claude/`ディレクトリのファイルを参照
2. **具体的に指示** - ファイルパス、関数名、行番号を明示
3. **効率的なワークフロー** - タスクをバッチ処理、過去の履歴を参照

これらを実践することで、トークン消費を大幅に削減し、プラン使用制限を回避できます。
