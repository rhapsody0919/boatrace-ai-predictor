# Firebase vs Supabase 比較 - ボートレースAI予想システム

## 🎯 結論: **Supabaseを推奨**

このプロジェクトには**Supabase**が最適です。理由は以下の通りです。

---

## 📊 無料プランの比較

### Supabase（無料プラン）

| 項目 | 制限 | このプロジェクトでの使用量見積もり |
|------|------|--------------------------------|
| **データベース容量** | 500MB | 約50-100MB（1年分）✅ 十分 |
| **APIリクエスト** | **無制限** | 1時間ごと24回/日 = 約720回/月 ✅ 問題なし |
| **同時接続数** | 200 | 1（スクリプトのみ）✅ 問題なし |
| **プロジェクト数** | 2つまで | 1つ ✅ 問題なし |
| **ストレージ** | 1GB | 使用しない ✅ 問題なし |
| **一時停止** | 7日間アクティビティなし | 1時間ごと実行 ✅ 問題なし |

**✅ このプロジェクトでは無料プランで十分運用可能**

---

### Firebase（Sparkプラン）

| 項目 | 制限 | このプロジェクトでの使用量見積もり |
|------|------|--------------------------------|
| **Firestore容量** | 1GB | 使用しない（NoSQL）❌ |
| **読み取り** | 50,000回/日 | 約720回/日 ✅ 問題なし |
| **書き込み** | 20,000回/日 | 約720回/日 ✅ 問題なし |
| **PostgreSQL** | ❌ 提供なし | **リレーショナルDBが必要** ❌ |

**❌ FirebaseはNoSQL（Firestore）のみで、PostgreSQLを提供していない**

---

## 🔍 詳細比較

### 1. データベースの種類

#### Supabase ✅
- **PostgreSQL 15+** を提供
- リレーショナルデータベース
- SQLクエリが可能
- JOIN、集計、トランザクションが標準サポート
- **このプロジェクトの要件に完全一致**

#### Firebase ❌
- **Cloud Firestore（NoSQL）** のみ
- リレーショナルデータ構造には不向き
- JOINができない
- 複雑な集計クエリが困難
- **このプロジェクトには不適切**

---

### 2. このプロジェクトのデータ構造

**必要なデータ構造:**
```
venues (1) ──< (N) races
races (1) ──< (N) racers
races (1) ──< (N) predictions
races (1) ──< (1) results
```

**Supabase（PostgreSQL）:**
- ✅ 外部キー制約で整合性を保証
- ✅ JOINで効率的にデータ取得
- ✅ 集計クエリで統計計算が容易

**Firebase（Firestore）:**
- ❌ リレーショナル構造を表現するのが困難
- ❌ JOINができない（複数回クエリが必要）
- ❌ 集計クエリが制限的

---

### 3. クエリの例

#### 必要なクエリ例

**1. 日付でレース一覧を取得（JOIN使用）**
```sql
SELECT r.*, v.venue_name
FROM races r
JOIN venues v ON r.venue_code = v.venue_code
WHERE r.date = '2025-12-05'
ORDER BY r.venue_code, r.race_number;
```

**2. モデル別の的中率統計（集計クエリ）**
```sql
SELECT 
  model_type,
  COUNT(*) as total_races,
  SUM(CASE WHEN top_pick = rank1 THEN 1 ELSE 0 END) as hits,
  AVG(recovery_rate) as avg_recovery
FROM predictions p
JOIN results r ON p.race_id = r.race_id
WHERE r.finished = true
GROUP BY model_type;
```

**Supabase:**
- ✅ 標準SQLで記述可能
- ✅ インデックスで高速化
- ✅ 複雑な集計も1クエリで実行

**Firebase:**
- ❌ JOINができない（複数回クエリが必要）
- ❌ 集計関数が限定的
- ❌ パフォーマンスが劣る

---

### 4. データ量の見積もり

**1年あたりのデータ量:**
- races: 約52,560レコード
- racers: 約315,360レコード
- predictions: 約157,680レコード
- results: 約52,560レコード
- **合計: 約600MB（5年で約3GB）**

**Supabase無料プラン:**
- 500MBまで無料
- **1年分は問題なし**
- 2年目以降は有料プラン（$25/月）が必要になる可能性

**Firebase無料プラン:**
- 1GBまで無料
- ただし、NoSQLなので構造が異なる

---

### 5. APIリクエスト数

**このプロジェクトの使用量:**
- スクレイピング: 1時間ごと = 24回/日 = 約720回/月
- フロントエンド: ユーザーアクセスに応じて（予測困難）

**Supabase:**
- ✅ **APIリクエスト無制限**（無料プラン）
- ✅ 問題なし

**Firebase:**
- ✅ 読み取り: 50,000回/日（十分）
- ✅ 書き込み: 20,000回/日（十分）
- ⚠️ ただし、NoSQLなので構造が異なる

---

## 💰 コスト比較（無料プラン以降）

### Supabase

| プラン | 月額 | データベース容量 | APIリクエスト |
|--------|------|----------------|--------------|
| **Free** | $0 | 500MB | 無制限 |
| **Pro** | $25 | 8GB | 無制限 |
| **Team** | $599 | 8GB | 無制限 |

**無料プランで1-2年は運用可能**
- データ量が500MBを超えたらProプラン（$25/月）に移行

---

### Firebase

| プラン | 月額 | Firestore容量 | 読み取り/書き込み |
|--------|------|--------------|-----------------|
| **Spark（無料）** | $0 | 1GB | 50,000/20,000回/日 |
| **Blaze（従量課金）** | 従量 | 無制限 | 従量課金 |

**注意点:**
- 2025年10月以降、Cloud StorageはBlazeプラン必須
- 従量課金なので予測が困難
- **PostgreSQLを提供していない**

---

## 🎯 このプロジェクトでの推奨

### ✅ Supabaseを推奨する理由

1. **PostgreSQLベース**
   - リレーショナルデータ構造に最適
   - SQLクエリで複雑な集計が可能
   - JOIN、トランザクションが標準サポート

2. **無料プランで十分**
   - 500MBの容量（1-2年分のデータ）
   - APIリクエスト無制限
   - このプロジェクトの使用量なら問題なし

3. **スケーラビリティ**
   - データ量が増えてもProプラン（$25/月）で対応可能
   - 料金体系が明確

4. **開発体験**
   - PostgreSQLなので標準SQLが使える
   - 既存のツール（pgAdmin、DBeaverなど）が使える
   - マイグレーションが容易

---

### ❌ Firebaseが不適切な理由

1. **NoSQLのみ**
   - PostgreSQLを提供していない
   - リレーショナルデータ構造に不向き

2. **クエリの制限**
   - JOINができない
   - 複雑な集計クエリが困難
   - パフォーマンスが劣る可能性

3. **コスト予測が困難**
   - 従量課金制
   - 使用量が増えると予想外のコストが発生

---

## 📝 実装時の注意点（Supabase）

### 1. プロジェクト作成

1. https://supabase.com にアクセス
2. アカウント作成（GitHubアカウントでログイン推奨）
3. 新しいプロジェクトを作成
4. データベース接続情報を取得

### 2. 接続情報の設定

**環境変数:**
```env
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres
```

**Supabaseダッシュボードから取得:**
- Settings → Database → Connection string

### 3. データベース容量の監視

**無料プラン（500MB）の使用状況:**
- Supabaseダッシュボードで確認可能
- 400MBを超えたらProプランへの移行を検討

### 4. 一時停止の回避

**無料プランの制限:**
- 7日間アクティビティがないと一時停止
- **このプロジェクトは1時間ごと実行なので問題なし**

---

## 🚀 移行計画（Supabase使用時）

### フェーズ1: Supabaseプロジェクト作成
1. Supabaseアカウント作成
2. プロジェクト作成
3. 接続情報を取得

### フェーズ2: スキーマ適用
1. `scripts/db/schema.sql` をSupabase SQL Editorで実行
2. または `scripts/db/migrate.js` で適用

### フェーズ3: データ移行
1. `scripts/db/migrate-from-json.js` で既存データを移行
2. データ検証

### フェーズ4: スクリプトのDB対応
1. 環境変数 `DATABASE_URL` を設定
2. 各スクリプトをDB対応に変更

---

## 📊 まとめ

| 項目 | Supabase | Firebase |
|------|----------|----------|
| **データベース** | ✅ PostgreSQL | ❌ NoSQLのみ |
| **無料プラン容量** | 500MB | 1GB（ただしNoSQL） |
| **APIリクエスト** | ✅ 無制限 | 50,000/20,000回/日 |
| **このプロジェクトへの適合性** | ✅ **最適** | ❌ 不適切 |
| **コスト予測** | ✅ 明確 | ⚠️ 予測困難 |

**結論: Supabaseを強く推奨**

---

## 🔗 参考リンク

- Supabase公式: https://supabase.com
- Supabase無料プラン詳細: https://supabase.com/pricing
- Supabaseドキュメント: https://supabase.com/docs
- PostgreSQL公式: https://www.postgresql.org/

