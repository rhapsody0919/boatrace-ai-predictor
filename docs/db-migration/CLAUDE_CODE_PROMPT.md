# Claude Codeç”¨ - DBç§»è¡Œå®Ÿè£…ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç§»è¡Œã—ã¾ã™ã€‚

**ç¾åœ¨ã®çŠ¶æ³:**
- ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿: `data/races.json` (ç´„13,861è¡Œ)
- äºˆæƒ³ãƒ‡ãƒ¼ã‚¿: `data/predictions/YYYY-MM-DD.json` (æ—¥ä»˜ã”ã¨ã€ç´„87Kãƒˆãƒ¼ã‚¯ãƒ³/ãƒ•ã‚¡ã‚¤ãƒ«)
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿: `data/predictions/summary.json` (ç´„7,679è¡Œ)
- 21æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ã„ã‚‹

**ç§»è¡Œã®ç›®çš„:**
- ãƒ‡ãƒ¼ã‚¿é‡å¢—åŠ ã¸ã®å¯¾å¿œ
- ã‚¯ã‚¨ãƒªæ€§èƒ½ã®å‘ä¸Š
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºä¿
- é‹ç”¨æ€§ã®å‘ä¸Š

---

## ğŸ¯ å®Ÿè£…ã‚¿ã‚¹ã‚¯

ä»¥ä¸‹ã®é †åºã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

### ã‚¿ã‚¹ã‚¯1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/db/schema.sql`

**å†…å®¹:**
1. ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹SQLã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ï¼š
   - `venues` - ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹å ´ãƒã‚¹ã‚¿ï¼ˆ24ä¼šå ´ï¼‰
   - `races` - ãƒ¬ãƒ¼ã‚¹æƒ…å ±
   - `racers` - é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¬ãƒ¼ã‚¹ã”ã¨ï¼‰
   - `predictions` - AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆ3ãƒ¢ãƒ‡ãƒ«: standard, safeBet, upsetFocusï¼‰
   - `volatility` - è’ã‚Œåº¦ã‚¹ã‚³ã‚¢
   - `results` - ãƒ¬ãƒ¼ã‚¹çµæœ
   - `accuracy_stats` - çš„ä¸­ç‡çµ±è¨ˆï¼ˆé›†è¨ˆæ¸ˆã¿ï¼‰
   - `venue_recommendations` - ä¼šå ´åˆ¥æ¨å¥¨ãƒ¢ãƒ‡ãƒ«

2. å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
3. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¨­å®š
4. åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆvenuesï¼‰ã‚’INSERT

**ã‚¹ã‚­ãƒ¼ãƒè©³ç´°ã¯ `docs/db-migration/DB_MIGRATION_PLAN.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**

---

### ã‚¿ã‚¹ã‚¯2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/utils/db.js`

**å†…å®¹:**
1. `pg` (node-postgres) ã‚’ä½¿ç”¨ã—ãŸæ¥ç¶šãƒ—ãƒ¼ãƒ«ã®å®Ÿè£…
2. ç’°å¢ƒå¤‰æ•° `DATABASE_URL` ã‹ã‚‰æ¥ç¶šæƒ…å ±ã‚’å–å¾—
3. æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
4. ä»¥ä¸‹ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å®Ÿè£…ï¼š
   ```javascript
   export async function query(text, params)
   export async function transaction(callback)
   export async function batchInsert(table, rows)
   ```

**ä¾å­˜é–¢ä¿‚:**
- `package.json` ã« `pg` ã‚’è¿½åŠ 

---

### ã‚¿ã‚¹ã‚¯3: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/db/migrate-from-json.js`

**å†…å®¹:**
1. æ—¢å­˜ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
   - `data/races.json`
   - `data/predictions/*.json` (summary.jsonä»¥å¤–)
   - `data/predictions/summary.json`

2. ãƒ‡ãƒ¼ã‚¿ã‚’DBã‚¹ã‚­ãƒ¼ãƒã«å¤‰æ›ã—ã¦æŒ¿å…¥
   - `races.json` â†’ `races`, `racers` ãƒ†ãƒ¼ãƒ–ãƒ«
   - `predictions/YYYY-MM-DD.json` â†’ `predictions`, `volatility` ãƒ†ãƒ¼ãƒ–ãƒ«
   - `summary.json` â†’ `accuracy_stats`, `venue_recommendations` ãƒ†ãƒ¼ãƒ–ãƒ«

3. é€²æ—è¡¨ç¤ºï¼ˆä½•ä»¶å‡¦ç†ã—ãŸã‹è¡¨ç¤ºï¼‰
4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆå¤±æ•—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼‰

**ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã®æ³¨æ„ç‚¹:**
- `raceId` ã®å½¢å¼: `"2025-12-05-01-01"` (date-venue-race)
- `predictions` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯3ãƒ¢ãƒ‡ãƒ«åˆ†ã‚’åˆ¥ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦æŒ¿å…¥
- `top3` ã¯ PostgreSQL ã®é…åˆ—å‹ `INTEGER[]` ã¨ã—ã¦ä¿å­˜
- `payouts`, `ai_scores` ã¯ JSONB å‹ã¨ã—ã¦ä¿å­˜

**å®Ÿè¡Œæ–¹æ³•:**
```bash
node scripts/db/migrate-from-json.js
```

---

### ã‚¿ã‚¹ã‚¯4: ã‚¹ã‚­ãƒ¼ãƒé©ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/db/migrate.js`

**å†…å®¹:**
1. `scripts/db/schema.sql` ã‚’èª­ã¿è¾¼ã‚€
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
3. SQLã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆ
4. æˆåŠŸ/å¤±æ•—ã‚’è¡¨ç¤º

**å®Ÿè¡Œæ–¹æ³•:**
```bash
node scripts/db/migrate.js
```

---

### ã‚¿ã‚¹ã‚¯5: scrape-to-json.js ã®DBå¯¾å¿œ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/scrape-to-json.js`

**å¤‰æ›´å†…å®¹:**
1. æ—¢å­˜ã®JSONæ›¸ãè¾¼ã¿å‡¦ç†ã‚’æ®‹ã—ã¤ã¤ã€DBæ›¸ãè¾¼ã¿ã‚‚è¿½åŠ 
2. ç’°å¢ƒå¤‰æ•° `USE_DATABASE=true` ã§DBæ›¸ãè¾¼ã¿ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯falseã§å¾Œæ–¹äº’æ›æ€§ã‚’ä¿ã¤ï¼‰
3. `races` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’æŒ¿å…¥ï¼ˆ`ON CONFLICT` ã§æ›´æ–°ï¼‰
4. `racers` ãƒ†ãƒ¼ãƒ–ãƒ«ã«é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æŒ¿å…¥
5. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã§æ•´åˆæ€§ã‚’ç¢ºä¿

**å®Ÿè£…ä¾‹ï¼ˆãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ©ã‚¤ãƒˆå¯¾å¿œï¼‰:**
```javascript
// JSONãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ï¼ˆå¸¸ã«å®Ÿè¡Œã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
await fs.writeFile(outputPath, JSON.stringify(outputData, null, 2));

// DBæ›¸ãè¾¼ã¿ï¼ˆç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ã€å¤±æ•—ã—ã¦ã‚‚JSONã¯æ®‹ã‚‹ï¼‰
if (process.env.USE_DATABASE === 'true') {
  try {
    await insertRacesToDB(racesData);
  } catch (error) {
    console.error('DBæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆJSONã¯æ­£å¸¸ã«ä¿å­˜æ¸ˆã¿ï¼‰:', error);
    // ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ãŒã€å‡¦ç†ã¯ç¶™ç¶šï¼ˆJSONã¯æˆåŠŸã—ã¦ã„ã‚‹ãŸã‚ï¼‰
  }
}
```

---

### ã‚¿ã‚¹ã‚¯6: generate-predictions.js ã®DBå¯¾å¿œ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/generate-predictions.js`

**å¤‰æ›´å†…å®¹:**
1. ç’°å¢ƒå¤‰æ•° `USE_DATABASE=true` ã§DBã‹ã‚‰èª­ã¿è¾¼ã¿ãƒ»æ›¸ãè¾¼ã¿
2. DBä½¿ç”¨æ™‚: `races` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
3. äºˆæƒ³ç”Ÿæˆå¾Œã€`predictions` ãƒ†ãƒ¼ãƒ–ãƒ«ã«3ãƒ¢ãƒ‡ãƒ«åˆ†ã‚’æŒ¿å…¥
4. `volatility` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è’ã‚Œåº¦ã‚¹ã‚³ã‚¢ã‚’æŒ¿å…¥
5. æ—¢å­˜ã®JSONæ›¸ãè¾¼ã¿ã¯ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯JSONï¼‰

**å®Ÿè£…ä¾‹ï¼ˆãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ©ã‚¤ãƒˆå¯¾å¿œï¼‰:**
```javascript
let racesData;
if (process.env.USE_DATABASE === 'true') {
  try {
    // DBã‹ã‚‰ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
    racesData = await getRacesFromDB(today);
  } catch (error) {
    console.error('DBèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
    // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    racesData = JSON.parse(await fs.readFile(racesPath, 'utf-8'));
  }
} else {
  // æ—¢å­˜ã®JSONå‡¦ç†
  racesData = JSON.parse(await fs.readFile(racesPath, 'utf-8'));
}

// äºˆæƒ³ç”Ÿæˆå‡¦ç†...

// JSONãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
await fs.writeFile(predictionPath, JSON.stringify(predictionData, null, 2));

// DBæ›¸ãè¾¼ã¿ï¼ˆç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ï¼‰
if (process.env.USE_DATABASE === 'true') {
  try {
    await insertPredictionsToDB(predictions);
  } catch (error) {
    console.error('DBæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆJSONã¯æ­£å¸¸ã«ä¿å­˜æ¸ˆã¿ï¼‰:', error);
  }
}
```

---

### ã‚¿ã‚¹ã‚¯7: scrape-results.js ã®DBå¯¾å¿œ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/scrape-results.js`

**å¤‰æ›´å†…å®¹:**
1. ç’°å¢ƒå¤‰æ•° `USE_DATABASE=true` ã§DBã‹ã‚‰èª­ã¿è¾¼ã¿ãƒ»æ›¸ãè¾¼ã¿
2. DBä½¿ç”¨æ™‚: `predictions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æœªå®Œäº†ã®ãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—
3. çµæœå–å¾—å¾Œã€`results` ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›´æ–°
4. æ—¢å­˜ã®JSONæ›´æ–°å‡¦ç†ã¯ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡

---

### ã‚¿ã‚¹ã‚¯8: calculate-accuracy.js ã®DBå¯¾å¿œ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/calculate-accuracy.js`

**å¤‰æ›´å†…å®¹:**
1. ç’°å¢ƒå¤‰æ•° `USE_DATABASE=true` ã§DBã‹ã‚‰èª­ã¿è¾¼ã¿ãƒ»æ›¸ãè¾¼ã¿
2. DBä½¿ç”¨æ™‚: `predictions`, `results` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
3. çµ±è¨ˆè¨ˆç®—å¾Œã€`accuracy_stats`, `venue_recommendations` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
4. æ—¢å­˜ã®summary.jsonç”Ÿæˆã¯ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### ã‚¿ã‚¹ã‚¯9: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `scripts/db/validate-migration.js`

**å†…å®¹:**
1. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã¨DBã®ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’æ¯”è¼ƒ
2. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•°ä»¶ï¼‰ã®å†…å®¹ã‚’æ¯”è¼ƒ
3. ä¸ä¸€è‡´ãŒã‚ã‚Œã°ãƒ­ã‚°å‡ºåŠ›
4. æ¤œè¨¼çµæœã‚’ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼ã§å‡ºåŠ›

**å®Ÿè¡Œæ–¹æ³•:**
```bash
node scripts/db/validate-migration.js
```

---

### ã‚¿ã‚¹ã‚¯10: ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `.env.example`

**å†…å®¹:**
```env
# Database
DATABASE_URL=postgresql://user:password@host:port/database

# Migration
USE_DATABASE=false  # true ã«ã™ã‚‹ã¨DBã‚’ä½¿ç”¨ã€false ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
```

---

## ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `package.json`

**è¿½åŠ ã™ã‚‹ä¾å­˜é–¢ä¿‚:**
```json
{
  "dependencies": {
    "pg": "^8.11.3"
  }
}
```

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰:**
```bash
npm install pg
```

---

## ğŸ”§ å®Ÿè£…æ™‚ã®æ³¨æ„äº‹é …

### 1. å¾Œæ–¹äº’æ›æ€§ã®ç¶­æŒ
- æ—¢å­˜ã®JSONãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã¯æ®‹ã™
- ç’°å¢ƒå¤‰æ•° `USE_DATABASE` ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã™ã‚‹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `false`ï¼ˆJSONä½¿ç”¨ï¼‰ã§æ—¢å­˜å‹•ä½œã‚’ç¶­æŒ

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ã¯é©åˆ‡ã«ã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ­ã‚°å‡ºåŠ›
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- éƒ¨åˆ†çš„ãªå¤±æ•—ã§ã‚‚å¯èƒ½ãªé™ã‚Šå‡¦ç†ã‚’ç¶™ç¶š

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒãƒƒãƒã‚¤ãƒ³ã‚µãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼ˆ1ä»¶ãšã¤INSERTã—ãªã„ï¼‰
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã‚’ã¾ã¨ã‚ã‚‹
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é©åˆ‡ã«è¨­å®š

### 4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¨­å®š
- `raceId` ã®ä¸€æ„æ€§ã‚’ä¿è¨¼
- æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€ï¼ˆYYYY-MM-DDï¼‰

### 5. ãƒ­ã‚°å‡ºåŠ›
- é€²æ—çŠ¶æ³ã‚’é©åˆ‡ã«è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼æ™‚ã¯è©³ç´°ãªæƒ…å ±ã‚’å‡ºåŠ›
- ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š

---

## ğŸ“ å®Ÿè£…é †åºã®æ¨å¥¨

1. **ã‚¿ã‚¹ã‚¯1**: ã‚¹ã‚­ãƒ¼ãƒä½œæˆï¼ˆ`schema.sql`ï¼‰
2. **ã‚¿ã‚¹ã‚¯2**: DBæ¥ç¶šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ`db.js`ï¼‰
3. **ã‚¿ã‚¹ã‚¯4**: ã‚¹ã‚­ãƒ¼ãƒé©ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`migrate.js`ï¼‰
4. **ã‚¿ã‚¹ã‚¯3**: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`migrate-from-json.js`ï¼‰
5. **ã‚¿ã‚¹ã‚¯9**: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`validate-migration.js`ï¼‰
6. **ã‚¿ã‚¹ã‚¯5-8**: å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®DBå¯¾å¿œï¼ˆé †ä¸åŒã§å¯ï¼‰
7. **ã‚¿ã‚¹ã‚¯10**: ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ`.env.example`ï¼‰

---

## âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿè£…å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] `scripts/db/schema.sql` ãŒä½œæˆã•ã‚Œã€å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] `scripts/utils/db.js` ãŒä½œæˆã•ã‚Œã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] `scripts/db/migrate.js` ã§ã‚¹ã‚­ãƒ¼ãƒãŒé©ç”¨ã§ãã‚‹
- [ ] `scripts/db/migrate-from-json.js` ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒç§»è¡Œã§ãã‚‹
- [ ] `scripts/db/validate-migration.js` ã§ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãŒã§ãã‚‹
- [ ] å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç’°å¢ƒå¤‰æ•° `USE_DATABASE` ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
- [ ] æ—¢å­˜ã®JSONå‡¦ç†ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‹•ä½œã™ã‚‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- [ ] `package.json` ã« `pg` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] `.env.example` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ã‚°å‡ºåŠ›ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

## ğŸš€ å®Ÿè¡Œæ‰‹é †ï¼ˆå®Ÿè£…å¾Œï¼‰

1. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
   ```bash
   cp .env.example .env
   # .env ã‚’ç·¨é›†ã—ã¦ DATABASE_URL ã‚’è¨­å®š
   ```

2. **ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   npm install
   ```

3. **ã‚¹ã‚­ãƒ¼ãƒã®é©ç”¨**
   ```bash
   node scripts/db/migrate.js
   ```

4. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆãƒ†ã‚¹ãƒˆï¼‰**
   ```bash
   node scripts/db/migrate-from-json.js
   ```

5. **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼**
   ```bash
   node scripts/db/validate-migration.js
   ```

6. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®DBå¯¾å¿œãƒ†ã‚¹ãƒˆ**
   ```bash
   USE_DATABASE=true node scripts/scrape-to-json.js
   USE_DATABASE=true node scripts/generate-predictions.js
   ```

---

## ğŸ“š å‚è€ƒè³‡æ–™

- `docs/db-migration/DB_MIGRATION_PLAN.md` - è©³ç´°ãªç§»è¡Œè¨ˆç”»ã¨ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ
- `ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œä»•æ§˜.md` - ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œä»•æ§˜
- PostgreSQLå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://www.postgresql.org/docs/
- node-postgres: https://node-postgres.com/

---

## ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆ

### ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã®ä¾‹

**JSON â†’ DB (races.json)**
```javascript
// JSONæ§‹é€ 
{
  "placeCd": 1,
  "placeName": "æ¡ç”Ÿ",
  "races": [{
    "date": "2025-12-05",
    "raceNo": 1,
    "racers": [...]
  }]
}

// DBæŒ¿å…¥
await pool.query(`
  INSERT INTO races (race_id, date, venue_code, race_number, ...)
  VALUES ($1, $2, $3, $4, ...)
  ON CONFLICT (race_id) DO UPDATE SET ...
`, ['2025-12-05-01-01', '2025-12-05', 1, 1, ...]);
```

**JSON â†’ DB (predictions)**
```javascript
// JSONæ§‹é€ 
{
  "predictions": {
    "standard": { "topPick": 1, "top3": [1, 4, 3], ... },
    "safeBet": { "topPick": 1, "top3": [1, 2, 4], ... },
    "upsetFocus": { "topPick": 4, "top3": [4, 3, 1], ... }
  }
}

// DBæŒ¿å…¥ï¼ˆ3ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
await pool.query(`
  INSERT INTO predictions (race_id, model_type, top_pick, top3, ...)
  VALUES ($1, 'standard', $2, $3, ...)
`, [raceId, 1, [1, 4, 3], ...]);
```

### ãƒãƒƒãƒã‚¤ãƒ³ã‚µãƒ¼ãƒˆã®ä¾‹

```javascript
// racers ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ä¸€æ‹¬æŒ¿å…¥
const values = racers.map((racer, i) => 
  `($${i*12+1}, $${i*12+2}, $${i*12+3}, ...)`
).join(', ');

const params = racers.flatMap(racer => [
  raceId, racer.lane, racer.name, racer.grade, ...
]);

await pool.query(`
  INSERT INTO racers (race_id, lane, name, grade, ...)
  VALUES ${values}
  ON CONFLICT (race_id, lane) DO UPDATE SET ...
`, params);
```

---

**ä»¥ä¸Šã§ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚**

