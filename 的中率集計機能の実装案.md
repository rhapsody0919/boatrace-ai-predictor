# 的中率集計機能の実装案

## 📝 要件定義

### 元の要望
> 前日の全レース合計の的中率および、前月/今月の全レースの的中率も集計して表示したい
> => DBが必要？だけど、簡易的に実装したい

### 具体的な要件

#### 1. 表示する的中率の種類
- **前日の的中率**: 昨日のすべてのレースの的中率
- **今月の的中率**: 今月（1日〜今日）のすべてのレースの的中率
- **前月の的中率**: 先月（1日〜末日）のすべてのレースの的中率
- **累計的中率**: サイト開始から現在までの的中率

#### 2. 的中の定義
以下の複数パターンで集計:

**パターンA: 本命的中**
- AI予想の本命（1位）が実際に1着になった場合を「的中」

**パターンB: トップ3推奨的中（3連単）**
- AI予想のトップ3が実際の1-2-3着に含まれた場合

**パターンC: トップ3推奨的中（3連複）**
- AI予想のトップ3が実際の1-2-3着と完全一致した場合

#### 3. 表示場所
- トップページのヘッダー下または専用セクション
- グラフ化（折れ線グラフ、円グラフ）

---

## 🏗️ システム設計

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                   フロントエンド (React)                 │
│  - 的中率ダッシュボード表示                              │
│  - グラフ表示 (Chart.js)                                │
└─────────────────────────────────────────────────────────┘
                           ↓ fetch
┌─────────────────────────────────────────────────────────┐
│              静的JSONファイル (GitHub Pages)             │
│  - data/predictions/2025-11-28.json                     │
│  - data/predictions/2025-11-29.json                     │
│  - data/predictions/summary.json (集計データ)            │
└─────────────────────────────────────────────────────────┘
                           ↑ 更新
┌─────────────────────────────────────────────────────────┐
│            GitHub Actions (自動化スクリプト)             │
│  1. レース結果をスクレイピング                           │
│  2. 過去の予想データと照合                               │
│  3. 的中率を計算                                         │
│  4. summary.json を更新                                  │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 データ構造

### 1. 予想データの保存形式

**ファイル**: `data/predictions/YYYY-MM-DD.json`

```json
{
  "date": "2025-11-28",
  "predictions": [
    {
      "raceId": "2025-11-28-03-01",  // 日付-場コード-レース番号
      "venue": "江戸川",
      "venueCode": 3,
      "raceNumber": 1,
      "startTime": "10:30",
      "predictedAt": "2025-11-28T01:25:00Z",
      "topPick": 1,                   // 本命予想
      "top3": [1, 3, 2],              // トップ3推奨
      "confidence": 78,               // 信頼度
      "result": {
        "finished": true,             // レース終了フラグ
        "rank1": 3,                   // 1着
        "rank2": 1,                   // 2着
        "rank3": 2,                   // 3着
        "updatedAt": "2025-11-28T02:35:00Z"
      },
      "accuracy": {
        "topPickHit": false,          // 本命的中
        "top3Hit": true,              // トップ3的中（3連複）
        "top3Included": true          // トップ3含まれる
      }
    }
    // ... 他のレース
  ]
}
```

### 2. 集計データの保存形式

**ファイル**: `data/predictions/summary.json`

```json
{
  "lastUpdated": "2025-11-28T23:30:00Z",
  "overall": {
    "totalRaces": 1250,
    "topPickHitRate": 0.315,        // 31.5%
    "top3HitRate": 0.623,           // 62.3%
    "top3IncludedRate": 0.784       // 78.4%
  },
  "yesterday": {
    "date": "2025-11-27",
    "totalRaces": 120,
    "topPickHitRate": 0.333,
    "top3HitRate": 0.650,
    "top3IncludedRate": 0.800
  },
  "thisMonth": {
    "year": 2025,
    "month": 11,
    "totalRaces": 850,
    "topPickHitRate": 0.321,
    "top3HitRate": 0.618,
    "top3IncludedRate": 0.776
  },
  "lastMonth": {
    "year": 2025,
    "month": 10,
    "totalRaces": 930,
    "topPickHitRate": 0.312,
    "top3HitRate": 0.605,
    "top3IncludedRate": 0.768
  },
  "dailyHistory": [
    {
      "date": "2025-11-27",
      "totalRaces": 120,
      "topPickHitRate": 0.333
    },
    {
      "date": "2025-11-26",
      "totalRaces": 118,
      "topPickHitRate": 0.305
    }
    // ... 過去30日分
  ]
}
```

---

## 🔧 実装方法（DBなし、GitHub Pagesで実現）

### アプローチ1: GitHub Actions + 静的JSONファイル（推奨）

#### ステップ1: 予想データの保存

**実装場所**: `src/App.jsx`

ユーザーが「AI予想を見る」をクリックした時に、予想データをlocalStorageに保存。

```javascript
const savePredict = (race, prediction) => {
  const today = new Date().toISOString().split('T')[0]
  const storageKey = `predictions_${today}`

  // 今日の予想データを取得
  const todayPredictions = JSON.parse(localStorage.getItem(storageKey) || '[]')

  // 予想データを追加
  const predictionData = {
    raceId: `${today}-${race.rawData.placeCd}-${race.raceNumber}`,
    venue: race.venue,
    venueCode: race.rawData.placeCd,
    raceNumber: race.raceNumber,
    startTime: race.startTime,
    predictedAt: new Date().toISOString(),
    topPick: prediction.topPick.number,
    top3: prediction.recommended.map(p => p.number),
    confidence: prediction.confidence,
    result: {
      finished: false
    }
  }

  // 既存データを更新または追加
  const existingIndex = todayPredictions.findIndex(p => p.raceId === predictionData.raceId)
  if (existingIndex >= 0) {
    todayPredictions[existingIndex] = predictionData
  } else {
    todayPredictions.push(predictionData)
  }

  localStorage.setItem(storageKey, JSON.stringify(todayPredictions))
}
```

#### ステップ2: レース結果のスクレイピング

**新規ファイル**: `scripts/scrape-results.js`

```javascript
// レース結果をスクレイピング
async function scrapeRaceResults(date) {
  const results = []

  // 各レース場のレース結果を取得
  for (let venueCode = 1; venueCode <= 24; venueCode++) {
    for (let raceNo = 1; raceNo <= 12; raceNo++) {
      try {
        const url = `https://www.boatrace.jp/owpc/pc/race/raceresult?rno=${raceNo}&jcd=${venueCode.toString().padStart(2, '0')}&hd=${date}`
        const html = await fetchWithRetry(url)
        const $ = cheerio.load(html)

        // 結果が存在するか確認
        const rank1 = $('.is-fs16.is-fBold').eq(0).text().trim()
        if (!rank1) continue  // まだ結果が出ていない

        results.push({
          raceId: `${date}-${venueCode}-${raceNo}`,
          rank1: parseInt(rank1),
          rank2: parseInt($('.is-fs16.is-fBold').eq(1).text().trim()),
          rank3: parseInt($('.is-fs16.is-fBold').eq(2).text().trim()),
          updatedAt: new Date().toISOString()
        })
      } catch (err) {
        // エラーは無視（レースが開催されていない場合）
      }
    }
  }

  return results
}
```

#### ステップ3: 予想と結果の照合・的中率計算

**新規ファイル**: `scripts/calculate-accuracy.js`

```javascript
function calculateAccuracy(predictions, results) {
  const accuracyData = predictions.map(pred => {
    const result = results.find(r => r.raceId === pred.raceId)

    if (!result) {
      return { ...pred, result: { finished: false } }
    }

    // 的中判定
    const topPickHit = pred.topPick === result.rank1
    const top3Hit = (
      pred.top3.includes(result.rank1) &&
      pred.top3.includes(result.rank2) &&
      pred.top3.includes(result.rank3)
    )
    const top3Included = (
      pred.top3[0] === result.rank1 &&
      pred.top3[1] === result.rank2 &&
      pred.top3[2] === result.rank3
    )

    return {
      ...pred,
      result: {
        finished: true,
        rank1: result.rank1,
        rank2: result.rank2,
        rank3: result.rank3,
        updatedAt: result.updatedAt
      },
      accuracy: {
        topPickHit,
        top3Hit,
        top3Included
      }
    }
  })

  return accuracyData
}

function calculateSummary(allPredictions) {
  const finishedRaces = allPredictions.filter(p => p.result?.finished)

  if (finishedRaces.length === 0) {
    return {
      totalRaces: 0,
      topPickHitRate: 0,
      top3HitRate: 0,
      top3IncludedRate: 0
    }
  }

  const topPickHits = finishedRaces.filter(p => p.accuracy?.topPickHit).length
  const top3Hits = finishedRaces.filter(p => p.accuracy?.top3Hit).length
  const top3Included = finishedRaces.filter(p => p.accuracy?.top3Included).length

  return {
    totalRaces: finishedRaces.length,
    topPickHitRate: topPickHits / finishedRaces.length,
    top3HitRate: top3Hits / finishedRaces.length,
    top3IncludedRate: top3Included / finishedRaces.length
  }
}
```

#### ステップ4: GitHub Actionsで自動化

**ファイル**: `.github/workflows/calculate-accuracy.yml`

```yaml
name: Calculate Prediction Accuracy

on:
  schedule:
    # 毎日23:00に実行（レース終了後）
    - cron: '0 14 * * *'  # UTC 14:00 = JST 23:00
  workflow_dispatch:

jobs:
  calculate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install cheerio

      - name: Scrape race results
        run: node scripts/scrape-results.js

      - name: Calculate accuracy
        run: node scripts/calculate-accuracy.js

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/predictions/
          git commit -m "Update prediction accuracy [automated]" || exit 0
          git push
```

#### ステップ5: フロントエンドで表示

**ファイル**: `src/components/AccuracyDashboard.jsx`

```jsx
function AccuracyDashboard() {
  const [summary, setSummary] = useState(null)

  useEffect(() => {
    fetch('/data/predictions/summary.json')
      .then(res => res.json())
      .then(data => setSummary(data))
      .catch(err => console.error(err))
  }, [])

  if (!summary) return <div>読み込み中...</div>

  return (
    <div className="accuracy-dashboard">
      <h2>📊 予想的中率</h2>

      {/* 前日 */}
      <div className="accuracy-card">
        <h3>前日（{summary.yesterday.date}）</h3>
        <div className="stats">
          <div className="stat-item">
            <span className="label">本命的中率</span>
            <span className="value">{(summary.yesterday.topPickHitRate * 100).toFixed(1)}%</span>
          </div>
          <div className="stat-item">
            <span className="label">トップ3的中率</span>
            <span className="value">{(summary.yesterday.top3HitRate * 100).toFixed(1)}%</span>
          </div>
        </div>
      </div>

      {/* 今月 */}
      <div className="accuracy-card">
        <h3>今月（{summary.thisMonth.year}年{summary.thisMonth.month}月）</h3>
        <div className="stats">
          <div className="stat-item">
            <span className="label">本命的中率</span>
            <span className="value">{(summary.thisMonth.topPickHitRate * 100).toFixed(1)}%</span>
          </div>
          <div className="stat-item">
            <span className="label">レース数</span>
            <span className="value">{summary.thisMonth.totalRaces}レース</span>
          </div>
        </div>
      </div>

      {/* グラフ */}
      <div className="accuracy-chart">
        <h3>的中率推移（過去30日）</h3>
        <Line data={chartData} />
      </div>
    </div>
  )
}
```

---

### アプローチ2: localStorage のみ（簡易版）

より簡易的な実装。ユーザーのブラウザに保存するだけ。

#### メリット
- すぐに実装できる（30分程度）
- GitHub Actionsなどの設定不要
- バックエンド不要

#### デメリット
- ユーザーごとに異なるデータ（同期されない）
- ブラウザのキャッシュクリアで消える
- 他のデバイスで見られない

#### 実装方法

```javascript
// 予想を保存
function savePrediction(race, prediction) {
  const key = `pred_${race.raceId}`
  localStorage.setItem(key, JSON.stringify({
    ...prediction,
    savedAt: new Date().toISOString()
  }))
}

// 結果を手動で入力（ユーザーが入力）
function updateResult(raceId, rank1, rank2, rank3) {
  const key = `pred_${raceId}`
  const pred = JSON.parse(localStorage.getItem(key))

  if (pred) {
    pred.result = { rank1, rank2, rank3 }
    pred.accuracy = calculateAccuracy(pred, { rank1, rank2, rank3 })
    localStorage.setItem(key, JSON.stringify(pred))
  }
}

// 的中率を計算
function getAccuracyStats() {
  const allPredictions = []
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i)
    if (key.startsWith('pred_')) {
      allPredictions.push(JSON.parse(localStorage.getItem(key)))
    }
  }

  const withResults = allPredictions.filter(p => p.result)
  const hits = withResults.filter(p => p.accuracy?.topPickHit).length

  return {
    total: withResults.length,
    hitRate: withResults.length > 0 ? hits / withResults.length : 0
  }
}
```

---

## 📊 実装難易度の評価

### アプローチ1: GitHub Actions + 静的JSON（推奨）

| 項目 | 難易度 | 所要時間 | 説明 |
|------|--------|----------|------|
| **1. 予想データ保存機能** | ⭐ 易 | 1時間 | localStorage に予想を保存 |
| **2. レース結果スクレイピング** | ⭐⭐ 中 | 3-4時間 | 既存のスクレイピングコードを流用 |
| **3. 的中率計算ロジック** | ⭐⭐ 中 | 2-3時間 | 予想と結果を照合して計算 |
| **4. GitHub Actions設定** | ⭐⭐ 中 | 1-2時間 | ワークフローファイル作成 |
| **5. フロントエンド表示** | ⭐⭐ 中 | 2-3時間 | ダッシュボード作成 |
| **6. グラフ表示** | ⭐⭐ 中 | 2-3時間 | Chart.js で可視化 |
| **合計** | ⭐⭐⭐ 中高 | **11-16時間** | 2-3日の作業 |

#### 技術的課題

1. **レース結果の取得タイミング**
   - レース終了直後は結果が反映されないことがある
   - 23:00の一括取得が現実的

2. **予想データのバックアップ**
   - GitHub リポジトリに保存されるので安全
   - ただし、ユーザーの予想閲覧データは取れない

3. **過去データの初期値**
   - サイト開始前のデータはゼロからスタート
   - 数週間でデータが蓄積される

---

### アプローチ2: localStorage のみ（簡易版）

| 項目 | 難易度 | 所要時間 | 説明 |
|------|--------|----------|------|
| **1. 予想データ保存** | ⭐ 易 | 30分 | localStorage に保存 |
| **2. 結果入力UI** | ⭐ 易 | 1時間 | ユーザーが手動で結果入力 |
| **3. 的中率計算** | ⭐ 易 | 1時間 | 簡易的な計算 |
| **4. 表示UI** | ⭐ 易 | 1-2時間 | シンプルな表示 |
| **合計** | ⭐ 易 | **3-4.5時間** | 半日の作業 |

#### デメリット

- ユーザーごとに異なるデータ
- 結果の手動入力が必要（面倒）
- サイト全体の的中率が見られない

---

## 🎯 推奨実装プラン

### フェーズ1: 最小限実装（1-2日）

1. **予想データの保存** (1時間)
   - localStorage に予想を保存
   - データ構造の定義

2. **レース結果スクレイピング** (3-4時間)
   - `scripts/scrape-results.js` を作成
   - 既存のスクレイピングコードを流用

3. **的中率計算** (2-3時間)
   - `scripts/calculate-accuracy.js` を作成
   - 照合ロジックの実装

4. **GitHub Actions設定** (1-2時間)
   - ワークフローファイル作成
   - 毎日自動実行

5. **簡易表示** (2時間)
   - summary.json を読み込んで表示
   - 数字だけのシンプルな表示

**合計: 9-12時間（1-2日）**

### フェーズ2: グラフ表示（追加1日）

6. **Chart.js 導入** (1時間)
7. **グラフコンポーネント作成** (2-3時間)
8. **スタイリング** (1-2時間)

**合計: 4-6時間（半日〜1日）**

---

## 💡 実装の判断ポイント

### 実装すべき理由

1. **信頼性の証明**
   - 的中率を公開することで透明性が高まる
   - ユーザーの信頼獲得

2. **差別化**
   - 他の予想サイトとの差別化
   - データドリブンなアプローチ

3. **ユーザーエンゲージメント**
   - 継続的に訪問する理由
   - 「今月の的中率はどうだろう？」

### 実装を後回しにする理由

1. **データ蓄積が必要**
   - 最低1ヶ月分のデータがないと意味がない
   - 今実装しても数字が少ない

2. **予想精度の向上が先**
   - 的中率が低いとマイナス効果
   - まずは予想ロジックの改善が優先

3. **実装工数**
   - 1-2日の作業時間が必要
   - 他の機能を優先すべきか

---

## 🚀 次のステップ

### 提案: 段階的実装

1. **今すぐ**: 予想データの保存だけ開始
   - localStorage に保存開始
   - データを蓄積し始める

2. **1週間後**: レース結果スクレイピング
   - 1週間分のデータが溜まってから

3. **2週間後**: 的中率表示
   - 十分なデータが溜まってから公開

---

## ❓ 質問・確認事項

1. **的中率を公開することについて**
   - 低い的中率が出た場合のリスクは許容できますか？
   - 30%程度でも問題ないですか？

2. **実装の優先度**
   - 他の機能（フェーズ2のグラフ表示など）と比べて優先度は？

3. **データの扱い**
   - ユーザーの予想閲覧履歴は取得しますか？
   - プライバシーへの配慮は？

---

**結論**: DBなしでも GitHub Actions + 静的JSONで十分実装可能。難易度は中程度で、1-2日の作業で最小限の機能が実装できます。
