name: Linear Task Sync

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, closed, synchronize ]

jobs:
  sync-linear:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get commit message
        id: commit-msg
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Pushã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              COMMIT_MSG=$(git log --format=%B ${{ github.event.before }}..${{ github.event.after }} | head -20)
            else
              COMMIT_MSG=$(git log --format=%B -1 ${{ github.event.after }})
            fi
          else
            # Pull Requestã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
            COMMIT_MSG=$(git log --format=%B ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | head -20)
            # PRã®ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ã‚‚å«ã‚ã‚‹
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            COMMIT_MSG="$PR_TITLE

$PR_BODY

$COMMIT_MSG"
          fi
          
          # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³æ–‡å­—åˆ—ã‚’å®‰å…¨ã«ä¿å­˜
          {
            echo 'EOF'
            echo "$COMMIT_MSG"
            echo 'EOF'
          } > /tmp/commit_msg.txt
          
          echo "commit_msg_file=/tmp/commit_msg.txt" >> $GITHUB_OUTPUT

      - name: Update Linear tasks
        if: steps.commit-msg.outputs.commit_msg_file != ''
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          GITHUB_COMMIT_MESSAGE: ${{ steps.commit-msg.outputs.commit_msg_file }}
        run: |
          if [ -z "$LINEAR_API_KEY" ]; then
            echo "âš ï¸ LINEAR_API_KEY is not set. Skipping Linear update."
            echo "ğŸ’¡ Linear GitHubçµ±åˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦ã§ã™ã€‚"
            exit 0
          fi
          
          COMMIT_MSG=$(cat "$GITHUB_COMMIT_MESSAGE" | tail -n +2 | head -n -1)
          
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
          echo "$COMMIT_MSG"
          echo ""
          
          # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦Linearã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
          node .github/scripts/linear-sync.js "$COMMIT_MSG"

